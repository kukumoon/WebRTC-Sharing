# WebRTC å­¦ä¹ è®°å½•åˆ†äº«
> `WebRTC` (Web Real-Time Communication) æ˜¯ä¸€ä¸ªå¯ä»¥ç”¨åœ¨è§†é¢‘èŠå¤©ï¼ŒéŸ³é¢‘èŠå¤©æˆ–P2Pæ–‡ä»¶åˆ†äº«ç­‰Web Appä¸­çš„ APIã€‚
  â€” MDN Web docs
    `WebRTC` is a new front in the long war for an open and unencumbered web. 
  `WebRTC` æŠ€æœ¯æ˜¯æ¿€çƒˆçš„å¼€æ”¾çš„ Web æˆ˜äº‰ä¸­ä¸€å¤§çªç ´âœŒï¸ã€‚
  â€” Brendan Eich

ä¿ºçš„è¿™ä¸ªåˆ†äº«ï¼Œå°±æŠŠè‡ªå·±é€šä¿—çš„ç†è§£é•¿è¯çŸ­è¯´æ’‚ã€‚
# ä»€ä¹ˆæ˜¯`WebRTC`ï¼Ÿ
æƒ³è±¡ä¸€ä¸‹æ‰‹æœºã€TV å’Œç”µè„‘éƒ½é€šè¿‡ç»Ÿä¸€å¹³å°è¿›è¡Œæ²Ÿé€šã€‚è¯•æƒ³ä¸€ä¸‹ï¼Œå¾ˆå®¹æ˜“çš„åœ¨ä½ çš„ç½‘ç«™ä¸­æ·»åŠ è§†é¢‘èŠå¤©å’Œ P2P æ•°æ®åˆ†äº«ã€‚è¿™æ˜¯ `WebRTC` æŠ€æœ¯çš„æ„¿æ™¯ã€‚

`WebRTC` æ˜¯ä¸€ä¸ªå¯ä»¥åœ¨ Web åº”ç”¨ç¨‹åºä¸­å®ç°éŸ³é¢‘ï¼Œè§†é¢‘å’Œæ•°æ®çš„å®æ—¶é€šä¿¡çš„å¼€æºé¡¹ç›®ã€‚åœ¨å®æ—¶é€šä¿¡ä¸­ï¼ŒéŸ³è§†é¢‘çš„é‡‡é›†å’Œå¤„ç†æ˜¯ä¸€ä¸ªå¾ˆå¤æ‚çš„è¿‡ç¨‹ã€‚æ¯”å¦‚éŸ³è§†é¢‘æµçš„ç¼–è§£ç ã€é™å™ªå’Œå›å£°æ¶ˆé™¤ç­‰ï¼Œä½†æ˜¯åœ¨ `WebRTC` ä¸­ï¼Œè¿™ä¸€åˆ‡éƒ½äº¤ç”±æµè§ˆå™¨çš„åº•å±‚å°è£…æ¥å®Œæˆã€‚æˆ‘ä»¬å¯ä»¥ç›´æ¥æ‹¿åˆ°ä¼˜åŒ–åçš„åª’ä½“æµï¼Œç„¶åå°†å…¶è¾“å‡ºåˆ°æœ¬åœ°å±å¹•å’Œæ‰¬å£°å™¨ï¼Œæˆ–è€…è½¬å‘ç»™å…¶å¯¹ç­‰ç«¯ã€‚é•¿è¯çŸ­è¯´ï¼Œå°±æ˜¯ä¸€ä¸ªæ”¯æŒç½‘é¡µæµè§ˆå™¨è¿›è¡Œå®æ—¶è¯­éŸ³å¯¹è¯ã€è§†é¢‘å¯¹è¯ã€æ•°æ®ä¼ è¾“çš„APIã€‚

åœ¨2013å¹´å’•å’•å™œ(Google) I/Oä¼šè®®ä¸Šï¼Œæœ‰å¯¹`WebRTC`å¤§è‡´ä»‹ç»ï¼šhttp://io13webrtc.appspot.com/#1

`WebRTC`å·²ç»å®ç°äº†å¯¹äºå®æ—¶é€šä¿¡ï¼Œå…æ’ä»¶éŸ³è§†é¢‘æ•°æ®ä¼ è¾“çš„æ ‡å‡†åˆ¶å®šï¼Œéœ€æ±‚æ˜¯ï¼š
- è®¸å¤šç½‘ç»œæœåŠ¡å·²ç»ä½¿ç”¨äº† RTCï¼Œä½†æ˜¯éœ€è¦ä¸‹è½½ï¼Œæœ¬åœ°åº”ç”¨æˆ–è€…æ˜¯æ’ä»¶ï¼›
- ä¸‹è½½å®‰è£…å‡çº§æ’ä»¶æ˜¯å¤æ‚çš„ï¼Œå¯èƒ½å‡ºé”™çš„ï¼Œä»¤äººåŒçƒ¦çš„ï¼›
- æ’ä»¶å¯èƒ½å¾ˆéš¾éƒ¨ç½²ã€è°ƒè¯•ã€æ•…éšœæ’é™¤ç­‰ï¼›
- æ’ä»¶å¯èƒ½éœ€è¦æŠ€æœ¯æˆæƒï¼Œå¤æ‚é›†æˆå’Œæ˜‚è´µçš„æŠ€æœ¯ï¼›

å› æ­¤ï¼Œ`WebRTC` é¡¹ç›®çš„æŒ‡å¯¼åŸåˆ™æ˜¯APIsåº”è¯¥æ˜¯å¼€æºçš„ï¼Œå…è´¹çš„ï¼Œæ ‡å‡†åŒ–çš„ï¼Œæµè§ˆå™¨å†…ç½®çš„ï¼Œæ¯”ç°æœ‰æŠ€æœ¯
æ›´é«˜æ•ˆçš„ã€‚
# æ—¶é—´çº¿
- 1876å¹´ï¼Œè´å°”å‘æ˜äº†ç”µè¯ï¼›
- 1990å¹´ï¼ŒGlobal IP Solutionså…¬å¸åœ¨ç‘å…¸æ–¯å¾·å“¥å°”æ‘©æˆç«‹ï¼›
- è€Œåï¼ŒSkypeã€è…¾è®¯ QQã€WebExã€Googleç­‰å…¬å¸éƒ½ä½¿ç”¨äº†å®ƒçš„éŸ³é¢‘å¤„ç†å¼•æ“ï¼›
- 2010å¹´2æœˆï¼ŒGoogleæ”¶è´­On2ï¼›åŒæ—¶è·å¾—å…¶VPxç³»åˆ—è§†é¢‘ç¼–è§£ç å™¨ï¼Œå¹¶å°†å…¶å¼€æºï¼›
- 2010å¹´5æœˆï¼ŒGoogleä»¥6820ä¸‡ç¾å…ƒæ”¶è´­VoIPè½¯ä»¶å¼€å‘å•†Global IP Solutionsçš„GIPSå¼•æ“ï¼Œå¼€æºx2ï¼›
- 2010å¹´5æœˆï¼Œ`WebRTC`å¼€æºé¡¹ç›®è¯ç”Ÿï¼šGIPSéŸ³è§†é¢‘å¼•æ“ + æ›¿æ¢æ‰H.264çš„VPxè§†é¢‘ç¼–è§£ç å™¨ï¼›
- 2011å¹´ï¼ŒGoogleå‘èµ·äº†WebTRCå¼€æºé¡¹ç›®å’Œæ ‡å‡†åŒ–å·¥ä½œï¼›
- 2012å¹´ï¼Œ`WebRTC`è¢«é›†æˆè¿›Chromeæµè§ˆå™¨ä¸­ï¼›
- 2013å¹´ï¼ŒGoogle I/O "Real-time communication with `WebRTC`" Presentationï¼›
- 2017å¹´ï¼Œç»è¿‡æ•°å¹´çš„æ”¹é€ ï¼Œ`WebRTC`1.0æ ‡å‡†è¿›å…¥Candidate Recommendationé˜¶æ®µï¼›
- 2017å¹´ï¼ŒEdgeä¸SafariåŠ å…¥äº†å¯¹`WebRTC`çš„æ”¯æŒï¼›è‡³æ­¤ï¼Œä¸»æµæµè§ˆå™¨å…¼å®¹æ€§âœ…ï¼›
- â€¦â€¦

# `WebRTC`ç»“æ„

![WebRTCç»“æ„å›¾](./webrtc.png "From 2013 Google I/O Presentation")            

æ¶æ„å›¾é¢œè‰²æ ‡è¯†è¯´æ˜ï¼š
- ç´«è‰²éƒ¨åˆ†æ˜¯Webå¼€å‘è€…APIå±‚ï¼›
- è“è‰²å®çº¿éƒ¨åˆ†æ˜¯é¢å‘æµè§ˆå™¨å‚å•†çš„APIå±‚ï¼›
- è“è‰²è™šçº¿éƒ¨åˆ†æµè§ˆå™¨å‚å•†å¯ä»¥è‡ªå®šä¹‰å®ç°ï¼›

å¦‚ä¸Šå›¾æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œ`WebRTC`æœ‰ä¸‰ä¸ªæ¨¡å—ï¼š
- Voice Engineï¼ˆéŸ³é¢‘å¼•æ“ï¼‰
  - Voice EngineåŒ…å«iSAC/iLBC Codecï¼ˆéŸ³é¢‘ç¼–è§£ç å™¨ï¼Œå‰è€…æ˜¯é’ˆå¯¹å®½å¸¦å’Œè¶…å®½å¸¦ï¼Œåè€…æ˜¯é’ˆå¯¹çª„å¸¦ï¼‰ï¼›
  - NetEQ for voiceï¼ˆå¤„ç†ç½‘ç»œæŠ–åŠ¨å’Œè¯­éŸ³åŒ…ä¸¢å¤±ï¼‰ï¼›
  - Echo Cancelerï¼ˆå›å£°æ¶ˆé™¤å™¨ï¼‰/ Noise Reductionï¼ˆå™ªå£°æŠ‘åˆ¶ï¼‰ï¼›
- Video Engineï¼ˆè§†é¢‘å¼•æ“ï¼‰
  - VP8 Codecï¼ˆè§†é¢‘å›¾åƒç¼–è§£ç å™¨ï¼‰ï¼›
  - Video jitter bufferï¼ˆè§†é¢‘æŠ–åŠ¨ç¼“å†²å™¨ï¼Œå¤„ç†è§†é¢‘æŠ–åŠ¨å’Œè§†é¢‘ä¿¡æ¯åŒ…ä¸¢å¤±ï¼‰ï¼›
  - Image enhancementsï¼ˆå›¾åƒè´¨é‡å¢å¼ºï¼‰ï¼›
- Transportï¼ˆæ•°æ®ä¼ è¾“ï¼‰
  - `SRTP`ï¼ˆå®‰å…¨çš„å®æ—¶ä¼ è¾“åè®®ï¼Œç”¨ä»¥éŸ³è§†é¢‘æµä¼ è¾“ï¼‰ï¼›
  - Multiplexingï¼ˆå¤šè·¯å¤ç”¨ï¼‰ï¼›
  - `P2P`ï¼Œ`STUN`+`TURN`+`ICE`ï¼ˆç”¨äº`NAT`ç½‘ç»œå’Œé˜²ç«å¢™ç©¿è¶Šçš„ï¼‰ï¼›
  - é™¤æ­¤ä¹‹å¤–ï¼Œå®‰å…¨ä¼ è¾“å¯èƒ½è¿˜ä¼šç”¨åˆ°`DTLS`ï¼ˆæ•°æ®æŠ¥å®‰å…¨ä¼ è¾“ï¼‰ï¼Œç”¨äºåŠ å¯†ä¼ è¾“å’Œå¯†é’¥åå•†ï¼›
  - æ•´ä¸ª`WebRTC`é€šä¿¡æ˜¯åŸºäºUDPçš„ï¼›

## æ ¸å¿ƒç»„ä»¶
- éŸ³è§†é¢‘å¼•æ“ï¼š`OPUS`ã€`VP8` / `VP9`ã€`H264`ï¼›
- ä¼ è¾“å±‚åè®®ï¼šåº•å±‚ä¼ è¾“åè®®ä¸º UDPï¼›
- åª’ä½“åè®®ï¼š`SRTP` / `SCTP`ï¼›
- æ•°æ®åè®®ï¼š`DTLS` / `SCTP`ï¼›
- P2P å†…ç½‘ç©¿é€ï¼š`STUN` / `TURN` / `ICE` / `Trickle ICE`ï¼›
- ä¿¡ä»¤ä¸ `SDP` åå•†ï¼š`HTTP` / `WebSocket` / `SIP`ã€ `Offer Answer` æ¨¡å‹ï¼›

## `WebRTC`éŸ³è§†é¢‘å¼•æ“
![WebRTCéŸ³è§†é¢‘å¼•æ“](./engine.png)
              
- æœ€åº•å±‚æ˜¯ç¡¬ä»¶è®¾å¤‡ï¼Œä¸Šé¢æ˜¯éŸ³é¢‘æ•è·æ¨¡å—å’Œè§†é¢‘æ•è·æ¨¡å—ï¼›
- ä¸­é—´éƒ¨åˆ†ä¸ºéŸ³è§†é¢‘å¼•æ“ã€‚éŸ³é¢‘å¼•æ“è´Ÿè´£éŸ³é¢‘é‡‡é›†å’Œä¼ è¾“ï¼Œå…·æœ‰é™å™ªã€å›å£°æ¶ˆé™¤ç­‰åŠŸèƒ½ã€‚è§†é¢‘å¼•æ“è´Ÿè´£ç½‘ç»œæŠ–åŠ¨ä¼˜åŒ–ï¼Œäº’è”ç½‘ä¼ è¾“ç¼–è§£ç ä¼˜åŒ–ï¼›
- åœ¨éŸ³è§†é¢‘å¼•æ“ä¹‹ä¸Šæ˜¯ ä¸€å¥— `C++` APIï¼Œåœ¨ `C++` çš„ API ä¹‹ä¸Šæ˜¯æä¾›ç»™æµè§ˆå™¨çš„`Javascript API`ï¼›

## `WebRTC`åè®®æ ˆ
![WebRTCåè®®æ ˆ](./protocol.png)
            
- `WebRTC` æ ¸å¿ƒçš„åè®®éƒ½æ˜¯åœ¨å³ä¾§åŸºäº `UDP` åŸºç¡€ä¸Šæ­å»ºèµ·æ¥çš„ï¼›
- å…¶ä¸­ï¼Œ`ICE`ã€`STUN`ã€`TURN` ç”¨äºå†…ç½‘ç©¿é€, è§£å†³äº†è·å–ä¸ç»‘å®šå¤–ç½‘æ˜ å°„åœ°å€ï¼Œä»¥åŠ `keep alive` æœºåˆ¶ï¼›
- `DTLS` ç”¨äºå¯¹ä¼ è¾“å†…å®¹è¿›è¡ŒåŠ å¯†ï¼Œå¯ä»¥çœ‹åšæ˜¯ UDP ç‰ˆçš„ TLSã€‚ç”±äº `WebRTC` å¯¹å®‰å…¨æ¯”è¾ƒé‡è§†ï¼Œè¿™ä¸€å±‚æ˜¯å¿…é¡»çš„ã€‚æ‰€æœ‰`WebRTC`ç»„ä»¶éƒ½å¿…é¡»åŠ å¯†ï¼Œå¹¶ä¸”å…¶`JavaScript API`åªèƒ½ç”¨äºå®‰å…¨æºï¼ˆ`HTTPS`æˆ–æœ¬åœ°ä¸»æœºï¼‰ã€‚ä¿¡ä»¤æœºåˆ¶å¹¶ä¸æ˜¯ç”±`WebRTC`æ ‡å‡†å®šä¹‰çš„ï¼Œæ‰€ä»¥å¿…é¡»ç¡®ä¿ä½¿ç”¨å®‰å…¨åè®®ï¼›
- `SRTP` ä¸ SCTP æ˜¯å¯¹åª’ä½“æ•°æ®çš„å°è£…ä¸ä¼ è¾“æ§åˆ¶åè®®ï¼›
- `SCTP` æ˜¯æµæ§åˆ¶ä¼ è¾“åè®®ï¼Œæä¾›ç±»ä¼¼ TCP çš„ç‰¹æ€§ï¼ŒSCTP å¯ä»¥åŸºäº UDP ä¸Šæ„å»ºï¼Œåœ¨ `WebRTC` é‡Œæ˜¯åœ¨ `DTLS` åè®®ä¹‹ä¸Šï¼›
- `RTCPeerConnection` ç”¨æ¥å»ºç«‹å’Œç»´æŠ¤ç«¯åˆ°ç«¯è¿æ¥ï¼Œå¹¶æä¾›é«˜æ•ˆçš„éŸ³è§†é¢‘æµä¼ è¾“ï¼›
- `RTCDataChannel` ç”¨æ¥æ”¯æŒç«¯åˆ°ç«¯çš„ä»»æ„äºŒè¿›åˆ¶æ•°æ®ä¼ è¾“ï¼›
- `WebRTC` åè®®æ ˆè§£é‡Šï¼š
  - `ICE`ï¼šäº’åŠ¨å¼è¿æ¥å»ºç«‹ï¼ˆRFC 5245ï¼‰ï¼›
  - `STUN`ï¼šç”¨äº`NAT`çš„ä¼šè¯éå†å®ç”¨ç¨‹åºï¼ˆRFC 5389ï¼‰ï¼›
  - `TURN`ï¼šåœ¨`NAT`å‘¨å›´ä½¿ç”¨ç»§ç”µå™¨è¿›è¡Œéå†ï¼ˆRFC 5766ï¼‰ï¼›
  - `SDP`ï¼šä¼šè¯æè¿°åè®®ï¼ˆRFC 4566ï¼‰ï¼›
  - `DTLS`ï¼šæ•°æ®æŠ¥ä¼ è¾“å±‚å®‰å…¨æ€§ï¼ˆRFC 6347ï¼‰ï¼›
  - `SCTP`ï¼šæµæ§åˆ¶ä¼ è¾“åè®®ï¼ˆRFC 4960ï¼‰ï¼›
  - `SRTP`ï¼šå®‰å…¨å®æ—¶ä¼ è¾“åè®®ï¼ˆRFC 3711ï¼‰ï¼›

ç°åœ¨çœ‹åˆ°è¿™äº›åƒå¥‡ç™¾æ€ªçš„åè®®ï¼Œä¿ºä¹Ÿæ˜¯ä¸€å¤´é›¾æ°´(Â¬_Â¬)ï¼Œæ¢ä¸ªè§’åº¦æ¥ç€å­¦ä¹ ã€‚
# `WebRTC`é€šè¯åŸç†
æˆ‘ä»¬å¯ä»¥ä¸€èµ·æ€è€ƒä»¥ä¸‹ä¸€æ¬¡`WebRTC`é€šè¯çš„éš¾ç‚¹ç—›ç‚¹ã€‚æ¯”å¦‚ï¼Œåœ¨ä¸¤ä¸ªå®Œå…¨ä¸åŒçš„ç½‘ç»œç¯å¢ƒã€å¤šåª’ä½“ç¡¬ä»¶çš„è®¾å¤‡ä¸Šï¼Œå¦‚ä½•è¿›è¡Œå®æ—¶çš„éŸ³è§†é¢‘é€šè¯ï¼Ÿ
## åª’ä½“åå•†
é¦–å…ˆä¸¤ç«¯ä¹‹é—´åº”è¯¥åå•†å¥½å½¼æ­¤æ”¯æŒçš„åª’ä½“æ ¼å¼ã€‚
![WebRTCåª’ä½“äº¤æ¢](./p2pmedia.png)
            
å¦‚ä¸Šå›¾å‡è®¾æœ‰ä¸¤ä¸ªè®¾å¤‡Peer Aä»¥åŠPeer Bï¼Œé€šè¿‡åå•†ä¸¤å°è®¾å¤‡çŸ¥é“å½¼æ­¤å…¼å®¹çš„è§†é¢‘ç¼–è§£ç å™¨æ˜¯H.264ã€‚
å› æ­¤è¦å®Œæˆåª’ä½“ä¿¡æ¯çš„äº¤æ¢ï¼Œå°±è¦ç”¨åˆ°ä¸Šè¿°çš„`SDP`åè®®äº†ã€‚

> `SDP`ï¼Œä¼šè¯æè¿°åè®®ï¼ˆSession Description Protocolæˆ–ç®€å†™`SDP`ï¼‰æè¿°çš„æ˜¯æµåª’ä½“çš„åˆå§‹åŒ–å‚æ•°ã€‚æ­¤åè®®ç”±IETFå‘è¡¨ä¸º RFC 2327ã€‚ `SDP`æœ€åˆçš„æ—¶å€™æ˜¯ä¼šè¯å‘å¸ƒåè®®ï¼ˆSession Announcement Protocolæˆ–ç®€å†™SAPï¼‰çš„ä¸€ä¸ªéƒ¨ä»¶ï¼Œ1998å¹´4æœˆæ¨å‡ºç¬¬ä¸€ç‰ˆï¼Œä½†æ˜¯ä¹‹åè¢«å¹¿æ³›ç”¨äºå’ŒRTSPä»¥åŠSIPååŒå·¥ä½œï¼Œä¹Ÿå¯è¢«å•ç‹¬ç”¨æ¥æè¿°å¤šæ’­ä¼šè¯ã€‚
â€”â€”Wikipedia

å› æ­¤ï¼Œåœ¨`WebRTC`ä¸­ï¼Œåª’ä½“èƒ½åŠ›æœ€ç»ˆé€šè¿‡ `SDP` å‘ˆç°ã€‚åœ¨ä¼ è¾“åª’ä½“æ•°æ®ä¹‹å‰ï¼Œé¦–å…ˆè¦è¿›è¡Œåª’ä½“èƒ½åŠ›åå•†ï¼Œçœ‹åŒæ–¹éƒ½æ”¯æŒé‚£äº›ç¼–ç æ–¹å¼ï¼Œæ”¯æŒå“ªäº›åˆ†è¾¨ç‡ç­‰ã€‚åå•†çš„æ–¹æ³•æ˜¯é€šè¿‡ä¿¡ä»¤æœåŠ¡å™¨äº¤æ¢åª’ä½“èƒ½åŠ›ä¿¡æ¯ã€‚

              
            
`WebRTC` åª’ä½“åå•†çš„è¿‡ç§å¦‚ä¸Šå›¾æ‰€ç¤ºã€‚
- ç¬¬ä¸€æ­¥ï¼ŒAmy è°ƒç”¨ `createOffer` æ–¹æ³•åˆ›å»º offer æ¶ˆæ¯ã€‚offer æ¶ˆæ¯ä¸­çš„å†…å®¹æ˜¯ Amy çš„ `SDP` ä¿¡æ¯ã€‚
- ç¬¬äºŒæ­¥ï¼ŒAmy è°ƒç”¨ `setLocalDescription` æ–¹æ³•ï¼Œå°†æœ¬ç«¯çš„ `SDP` ä¿¡æ¯ä¿å­˜èµ·æ¥ã€‚
- ç¬¬ä¸‰æ­¥ï¼ŒAmy å°† offer æ¶ˆæ¯é€šè¿‡ä¿¡ä»¤æœåŠ¡å™¨ä¼ ç»™ Bobã€‚
- ç¬¬å››æ­¥ï¼ŒBob æ”¶åˆ° offer æ¶ˆæ¯åï¼Œè°ƒç”¨ setRemoteDescription æ–¹æ³•å°†å…¶å­˜å‚¨èµ·æ¥ã€‚
- ç¬¬äº”æ­¥ï¼ŒBob è°ƒç”¨ `createAnswer` æ–¹æ³•åˆ›å»º answer æ¶ˆæ¯ï¼Œ åŒæ ·ï¼Œanswer æ¶ˆæ¯ä¸­çš„å†…å®¹æ˜¯ Bob çš„ `SDP` ä¿¡æ¯ã€‚
- ç¬¬å…­æ­¥ï¼ŒBob è°ƒç”¨ `setLocalDescription` æ–¹æ³•ï¼Œå°†æœ¬ç«¯çš„ `SDP` ä¿¡æ¯ä¿å­˜èµ·æ¥ã€‚
- ç¬¬ä¸ƒæ­¥ï¼ŒBob å°† anwser æ¶ˆæ¯é€šè¿‡ä¿¡ä»¤æœåŠ¡å™¨ä¼ ç»™ Amyã€‚
- ç¬¬å…«æ­¥ï¼ŒAmy æ”¶åˆ° answer æ¶ˆæ¯åï¼Œè°ƒç”¨ `setRemoteDescription` æ–¹æ³•ï¼Œå°†å…¶ä¿å­˜èµ·æ¥ã€‚

æˆ‘ä»¬å¯ä»¥ç”¨`Javascript`æ¨¡æ‹Ÿä¸€ä¸‹è¿™ä¸ªè¿‡ç¨‹ï¼š
```javascript
// æ­¤å¤„æ¨¡æ‹Ÿä¸€ä¸ªä¿¡ä»¤æœåŠ¡ï¼Œå°±æ˜¯ä¸€ä¸ªç”¨æ¥äº¤æ¢ç«¯å’Œç«¯ä¹‹é—´SDPçš„ä¿¡ä»¤æœåŠ¡
const signaling = new SignalingChannel(); 
// å»ºç«‹ä¸€ä¸ªRTCç«¯
const pc = new RTCPeerConnection(null);
// å½“ä¸¤å°è®¾å¤‡éœ€è¦è¿›è¡Œåª’ä½“æ•°æ®çš„åå•†æ—¶ï¼Œè§¦å‘å¦‚ä¸‹æ–¹æ³•
pc.onnegotiationneeded = async () => {
    // åˆ›å»ºoffer å¹¶localä¿å­˜
    await pc.setLocalDescription(await pc.createOffer());
    // ç„¶åè°ƒç”¨ä¿¡ä»¤æœåŠ¡å°†æ•°æ®è¿›è¡Œä¼ è¾“
    signaling.send({desc: pc.localDescription});
};

// ä½¿ç”¨ä¿¡ä»¤æœåŠ¡åšSDPä¿¡æ¯çš„äº¤æ¢
signaling.onmessage = async ({desc}) => {
    if (desc) {
        // æ”¶åˆ°SDP offeråˆ™éœ€è¦è¿›è¡ŒSDP answer
        if (desc.type === 'offer') {
            await pc.setRemoteDescription(desc); // ä¿å­˜remote SDP
            // è®¾ç½®local SDP, å¹¶answer remote
            await pc.setLocalDescription(await pc.createAnswer());
            // é€šè¿‡ä¿¡ä»¤ä¼ é€’
            signaling.send({desc: pc.localDescription});
        } else if (desc.type === 'answer') {
            // å¦‚æœæ”¶åˆ°çš„æ˜¯answerï¼Œlocalç«¯è¿›è¡Œå­˜å‚¨ï¼Œæ­¤æ—¶åª’ä½“ä¿¡æ¯äº¤æ¢å®Œæˆ
            await pc.setRemoteDescription(desc);
        }
    }
};
```
å¯¹äºåª’ä½“æ ¼å¼ï¼Œæ—¥åä¼šæƒ³åŠæ³•æ·±å…¥ç ”ç©¶ä¸€ä¸‹ã€‚
## ç½‘ç»œåå•†
å½¼æ­¤è¦äº†è§£å¯¹æ–¹çš„ç½‘ç»œæƒ…å†µï¼Œè¿™æ ·æ‰æœ‰å¯èƒ½æ‰¾åˆ°ä¸€æ¡ç›¸äº’é€šè®¯çš„é“¾è·¯ã€‚
è¿™é‡Œé¦–å…ˆè¦æ€»ç»“ä¸€ä¸‹ç»“è®ºï¼Œç„¶åè·³è¿›å¦ä¸€ä¸ªæ¼«é•¿çš„å¤æ‚çš„æˆ‘ä¹Ÿæ²¡æå¤ªæ˜ç™½çš„è¯é¢˜ã€‚

ç½‘ç»œåå•†çš„ç†æƒ³æ­¥éª¤æ˜¯ï¼š
- è·å–å½“å‰ç«¯çš„å¤–ç½‘IPåœ°å€æ˜ å°„
- é€šè¿‡ä¿¡ä»¤æœåŠ¡äº¤æ¢ç½‘ç»œä¿¡æ¯ï¼šä¸Šè¿°ä»£ç ä¸­çš„ä¿¡ä»¤å¸¸é‡signaling

é—®é¢˜äºŒè¿ï¼š
- ä½†å¦‚ä½•è·å–å½“å‰ç«¯çš„å¤–ç½‘IPåœ°å€æ˜ å°„ï¼Ÿ
- ä¸ºä»€ä¹ˆè¦åŒºåˆ†å†…å¤–ç½‘IPï¼Ÿ

ä¸€ä¸ªå…³äº`IPv4`çš„å°æ•…äº‹
> æ³¨ï¼šä¸‹è¾¹çš„æ•…äº‹å†…å®¹æºè‡ªç½‘ç»œğŸ’ï¼š

2011å¹´2æœˆ3æ—¥ä¸­å›½å†œå†æ–°å¹´ï¼Œ IANAå¯¹å¤–å®£å¸ƒï¼š`IPv4`åœ°å€ç©ºé—´æœ€å5ä¸ªåœ°å€å—å·²ç»è¢«åˆ†é…ç»™ä¸‹å±çš„5ä¸ªåœ°åŒºå§”å‘˜ä¼šã€‚2011å¹´4æœˆ15æ—¥ï¼Œäºšå¤ªåŒºå§”å‘˜ä¼šAPNICå¯¹å¤–å®£å¸ƒï¼Œé™¤äº†ä¸ªåˆ«ä¿ç•™åœ°å€å¤–ï¼Œæœ¬åŒºåŸŸæ‰€æœ‰çš„`IPv4`åœ°å€åŸºæœ¬è€—å°½ã€‚ä¸€æ—¶ä¹‹é—´ï¼Œ`IPv4`åœ°å€ä½œä¸ºä¸€ç§æ¿’å±èµ„æºèº«ä»·é™¡å¢ï¼Œå„å¤§ç½‘ç»œå…¬å¸å‡ºå·¨èµ„æ”¶è´­å‰©ä½™çš„ç©ºé—²åœ°å€ã€‚å…¶å®ï¼Œ`IPv4`åœ°å€ä¸è¶³é—®é¢˜å·²ä¸æ˜¯æ–°é—®é¢˜ï¼Œæ—©åœ¨20å¹´ä»¥å‰ï¼Œ`IPv4`åœ°å€å³å°†è€—å°½çš„é—®é¢˜å°±å·²ç»æ‘†åœ¨Internetå…ˆé©±ä»¬é¢å‰ã€‚è¿™ä¸ç¦è®©æˆ‘ä»¬æƒ³å»äº†è§£ï¼Œæ˜¯ä»€ä¹ˆæŠ€æœ¯ä½¿è¿™ä¸€å±æœºå»¶ç¼“äº†å°½20å¹´ã€‚

`IPv4`å³ç½‘é™…ç½‘åè®®ç¬¬4ç‰ˆâ€”â€”Internet Protocol Version 4çš„ç¼©å†™ã€‚`IPv4`å®šä¹‰ä¸€ä¸ªè·¨è¶Šå¼‚ç§ç½‘ç»œäº’è¿çš„è¶…çº§ç½‘ï¼Œå®ƒä¸ºæ¯ä¸ªç½‘é™…ç½‘çš„èŠ‚ç‚¹åˆ†é…å…¨çƒå”¯ä¸€IPåœ°å€ã€‚å¦‚æœæˆ‘ä»¬æŠŠInternetæ¯”ä½œä¸€ä¸ªé‚®æ”¿ç³»ç»Ÿï¼Œé‚£ä¹ˆIPåœ°å€çš„ä½œç”¨å°±ç­‰åŒäºåŒ…å«åŸå¸‚ã€è¡—åŒºã€é—¨ç‰Œç¼–å·åœ¨å†…çš„å®Œæ•´åœ°å€ã€‚`IPv4`ä½¿ç”¨32bitsæ•´æ•°è¡¨è¾¾ä¸€ä¸ªåœ°å€ï¼Œåœ°å€æœ€å¤§èŒƒå›´å°±æ˜¯232 çº¦ä¸º43äº¿ã€‚ä»¥IPåˆ›å§‹æ—¶æœŸå¯è¢«è”ç½‘çš„è®¾å¤‡æ¥çœ‹ï¼Œè¿™æ ·çš„ä¸€ä¸ªç©ºé—´å·²ç»å¾ˆå¤§ï¼Œå¾ˆéš¾è¢«çŸ­æ—¶é—´ç”¨å®Œã€‚ç„¶è€Œï¼Œäº‹å®è¿œè¿œè¶…å‡ºäººä»¬çš„è®¾æƒ³ï¼Œè®¡ç®—æœºç½‘ç»œåœ¨æ­¤åçš„å‡ åå¹´é‡Œè¿…é€Ÿå£®å¤§ï¼Œç½‘ç»œç»ˆç«¯æ•°é‡å‘ˆçˆ†ç‚¸æ€§å¢é•¿ã€‚

æ›´ä¸ºç³Ÿç³•çš„æ˜¯ï¼Œä¸ºäº†è·¯ç”±å’Œç®¡ç†æ–¹ä¾¿ï¼Œ43äº¿çš„åœ°å€ç©ºé—´è¢«æŒ‰ç…§ä¸åŒå‰ç¼€é•¿åº¦åˆ’åˆ†ä¸ºA,B,C,Dç±»åœ°å€ç½‘ç»œå’Œä¿ç•™åœ°å€ã€‚å…¶ä¸­ï¼ŒAç±»ç½‘ç»œåœ°å€127æ®µï¼Œæ¯æ®µåŒ…æ‹¬ä¸»æœºåœ°å€çº¦1678ä¸‡ä¸ªã€‚Bç±»ç½‘ç»œåœ°å€16384æ®µï¼Œæ¯æ®µåŒ…æ‹¬65536ä¸ªä¸»æœºåœ°å€ã€‚

IANAå‘è¶…å¤§å‹ä¼ä¸š/ç»„ç»‡åˆ†é…Aç±»ç½‘ç»œåœ°å€ï¼Œä¸€æ¬¡ä¸€æ®µã€‚å‘ä¸­å‹ä¼ä¸šæˆ–æ•™è‚²æœºæ„åˆ†é…Bç±»ç½‘ç»œåœ°å€ï¼Œä¸€æ¬¡ä¸€æ®µã€‚è¿™æ ·ä¸€ç§åˆ†é…ç­–ç•¥ä½¿å¾—IPåœ°å€æµªè´¹å¾ˆä¸¥é‡ï¼Œå¾ˆå¤šè¢«åˆ†é…å‡ºå»çš„åœ°å€æ²¡æœ‰çœŸå®è¢«åˆ©ç”¨ï¼Œåœ°å€æ¶ˆè€—å¾ˆå¿«ã€‚ä»¥è‡³äºäºŒåä¸–çºª90å¹´ä»£åˆï¼Œç½‘ç»œä¸“å®¶ä»¬æ„è¯†åˆ°ï¼Œè¿™æ ·å¤§æ‰‹å¤§è„šä¸‹å»ï¼Œ`IPv4`åœ°å€å¾ˆå¿«å°±è¦è€—å…‰äº†ã€‚äºæ˜¯ï¼Œäººä»¬å¼€å§‹è€ƒè™‘`IPv4`çš„æ›¿ä»£æ–¹æ¡ˆï¼ŒåŒæ—¶é‡‡å–ä¸€ç³»åˆ—çš„æªæ–½æ¥å‡ç¼“`IPv4`åœ°å€çš„æ¶ˆè€—ã€‚

Internetèµ·åˆå¸Œæœ›å¤§å®¶äº’è”èµ·æ¥ï¼Œé€šè¿‡IPåœ°å€æ¥ä¿è¯äº’è”çš„å”¯ä¸€ä¸”å‡†ç¡®ï¼Œä½†ä¸‡ä¸‡æ²¡æƒ³åˆ°åŠ å…¥äº’è”ç½‘çš„è®¾å¤‡ç»ˆç«¯å±…ç„¶æœ‰è¿™ä¹ˆè¿™ä¹ˆå¤šã€‚äºæ˜¯ä¾¿å‡ºç°äº†`NAT`æŠ€æœ¯ï¼Œäº‹å®è¯æ˜`NAT`æœ‰åŠ©äºå‡ç¼“å¯ç”¨çš„IPåœ°å€ç©ºé—´çš„æ¯ç«­ã€‚åœ¨RFC2663ä¸­æœ‰å¯¹`NAT`å…·ä½“çš„è¯´æ˜ã€‚

### `NAT` & `NAT`ç©¿é€
`NAT`å³ç½‘ç»œåœ°å€è½¬æ¢ï¼Œå°±æ˜¯æ›¿æ¢IPæŠ¥æ–‡å¤´éƒ¨çš„åœ°å€ä¿¡æ¯ã€‚`NAT`é€šå¸¸éƒ¨ç½²åœ¨ä¸€ä¸ªç»„ç»‡çš„ç½‘ç»œå‡ºå£ä½ç½®ï¼Œé€šè¿‡å°†å†…éƒ¨ç½‘ç»œIPè½¬æ¢ä¸ºå‡ºå£çš„IPåœ°å€æä¾›å…¬ç½‘å¯è¾¾ä»¥åŠå’Œä¸Šå±‚åè®®çš„è¿æ¥èƒ½åŠ›ã€‚

RFC1918è§„å®šäº†ä¸‰ä¸ªä¿ç•™åœ°å€æ®µè½ï¼š
- 10.0.0.0-10.255.255.255
- 172.16.0.0-172.31.255.255
- 192.168.0.0-192.168.255.255

è¿™ä¸‰ä¸ªèŒƒå›´åˆ†åˆ«å¤„äºA,B,Cç±»çš„åœ°å€æ®µï¼Œä¸å‘ç‰¹å®šçš„ç”¨æˆ·åˆ†é…ï¼Œè¢«IANAä½œä¸ºç§æœ‰åœ°å€ä¿ç•™ã€‚è¿™äº›åœ°å€å¯ä»¥åœ¨ä»»ä½•ç»„ç»‡æˆ–ä¼ä¸šå†…éƒ¨ä½¿ç”¨ï¼Œå’Œå…¶ä»–Internetåœ°å€çš„åŒºåˆ«å°±æ˜¯ï¼Œä»…èƒ½åœ¨å†…éƒ¨ä½¿ç”¨ï¼Œä¸èƒ½ä½œä¸ºå…¨çƒè·¯ç”±åœ°å€ã€‚å¯¹äºæœ‰Internetè®¿é—®éœ€æ±‚è€Œå†…éƒ¨åˆä½¿ç”¨ç§æœ‰åœ°å€çš„ç½‘ç»œï¼Œå°±è¦åœ¨ç»„ç»‡çš„å‡ºå£ä½ç½®éƒ¨ç½²`NAT`ç½‘å…³ï¼Œåœ¨æŠ¥æ–‡ç¦»å¼€ç§ç½‘è¿›å…¥Internetæ—¶ï¼Œå°†æºIPæ›¿æ¢ä¸ºå…¬ç½‘åœ°å€ï¼Œé€šå¸¸æ˜¯å‡ºå£è®¾å¤‡çš„æ¥å£åœ°å€ã€‚ä¸€ä¸ªå¯¹å¤–çš„è®¿é—®è¯·æ±‚åœ¨åˆ°è¾¾ç›®æ ‡ä»¥åï¼Œè¡¨ç°ä¸ºç”±æœ¬ç»„ç»‡å‡ºå£è®¾å¤‡å‘èµ·ï¼Œå› æ­¤è¢«è¯·æ±‚çš„æœåŠ¡ç«¯å¯å°†å“åº”ç”±Internetå‘å›å‡ºå£ç½‘å…³ã€‚å‡ºå£ç½‘å…³å†å°†ç›®çš„åœ°å€æ›¿æ¢ä¸ºç§ç½‘çš„æºä¸»æœºåœ°å€ï¼Œå‘å›å†…éƒ¨ã€‚è¿™æ ·ä¸€æ¬¡ç”±ç§ç½‘ä¸»æœºå‘å…¬ç½‘æœåŠ¡ç«¯çš„è¯·æ±‚å’Œå“åº”å°±åœ¨é€šä¿¡ä¸¤ç«¯å‡æ— æ„ŸçŸ¥çš„æƒ…å†µä¸‹å®Œæˆäº†ã€‚ä¾æ®è¿™ç§æ¨¡å‹ï¼Œæ•°é‡åºå¤§çš„å†…ç½‘ä¸»æœºå°±ä¸å†éœ€è¦å…¬æœ‰IPåœ°å€äº†ã€‚

æ‰€æœ‰`NAT`éƒ½å¯åˆ†ä¸ºå‡ ç±»ï¼š
1. é™æ€`NAT`ï¼š
å°†å•ä¸ªç§æœ‰IPåœ°å€ä¸å•ä¸ªå…¬å…±åœ°å€æ˜ å°„ï¼Œå³å°†ç§æœ‰IPåœ°å€è½¬æ¢ä¸ºå…¬å…±IPåœ°å€ã€‚
2. åŠ¨æ€`NAT`ï¼š
åœ¨è¿™ç§ç±»å‹çš„`NAT`ä¸­ï¼Œå¤šä¸ªä¸“ç”¨IPåœ°å€æ˜ å°„åˆ°å…¬ç”¨IPåœ°å€æ± ã€‚å½“æˆ‘ä»¬çŸ¥é“å›ºå®šç”¨æˆ·æƒ³è¦åœ¨ç»™å®šçš„æ—¶é—´ç‚¹è®¿é—®Internetçš„æ•°é‡æ—¶ï¼Œå°†ä½¿ç”¨å®ƒã€‚
3. PATï¼ˆ`NAT`é‡è½½ï¼‰ï¼š
ä½¿ç”¨`NAT`é‡è½½å¯ä»¥å°†è®¸å¤šæœ¬åœ°ï¼ˆä¸“ç”¨ï¼‰IPåœ°å€è½¬æ¢ä¸ºå•ä¸ªå…¬ç”¨IPåœ°å€ã€‚ç«¯å£å·ç”¨äºåŒºåˆ†æµé‡ï¼Œå³å“ªä¸ªæµé‡å±äºå“ªä¸ªIPåœ°å€ã€‚è¿™æ˜¯æœ€å¸¸ç”¨çš„æ–¹æ³•ï¼Œå› ä¸ºå®ƒå…·æœ‰æˆæœ¬æ•ˆç›Šï¼Œå› ä¸ºä»…ä½¿ç”¨ä¸€ä¸ªçœŸå®çš„å…¨å±€ï¼ˆå…¬å…±ï¼‰IPåœ°å€å°±å¯ä»¥å°†æ•°åƒä¸ªç”¨æˆ·è¿æ¥åˆ°Internetã€‚

### `STUN`åè®®
#### ç®€ä»‹
`STUN`åè®®å…¨ç§°Simple traversal of UDP over `NAT`s protocolï¼Œæ˜¯ä¸€ç§ç½‘ç»œåè®®ï¼Œå®ƒå…è®¸ä½äº`NAT`åçš„å®¢æˆ·ç«¯æ‰¾å‡ºè‡ªå·±çš„å…¬ç½‘åœ°å€ï¼ŒæŸ¥å‡ºè‡ªå·±ä½äºå“ªç§ç±»å‹çš„`NAT`ä¹‹åä»¥åŠ`NAT`ä¸ºæŸä¸€ä¸ªæœ¬åœ°ç«¯å£æ‰€ç»‘å®šçš„Internetç«¯ç«¯å£ã€‚è¿™äº›ä¿¡æ¯è¢«ç”¨æ¥åœ¨ä¸¤ä¸ªåŒæ—¶å¤„äº`NAT`è·¯ç”±å™¨ä¹‹åçš„ä¸»æœºä¹‹é—´åˆ›å»ºUDPé€šä¿¡ã€‚é»˜è®¤ç«¯å£å·æ˜¯3478ã€‚å®ƒå°†`NAT`å®ç°åˆ†ä¸ºå››ç§ï¼š
åˆ†ç±»
1. Full-cone `NAT`ï¼Œaka one-to-one `NAT`
- å®Œå…¨é”¥å½¢`NAT`ï¼Œæ‰€æœ‰ä»åŒä¸€ä¸ªå†…ç½‘IPå’Œç«¯å£å·å‘é€è¿‡æ¥çš„è¯·æ±‚éƒ½ä¼šè¢«æ˜ å°„æˆåŒä¸€ä¸ªå¤–ç½‘IPå’Œç«¯å£å·ï¼Œå¹¶ä¸”ä»»ä½•ä¸€ä¸ªå¤–ç½‘ä¸»æœºéƒ½å¯ä»¥é€šè¿‡è¿™ä¸ªæ˜ å°„çš„å¤–ç½‘IPå’Œç«¯å£å·å‘è¿™å°å†…ç½‘ä¸»æœºå‘é€åŒ…ã€‚
![å®Œå…¨é”¥å½¢NAT](./fullconenat.png)

              
            
2. (Address)-restricted-cone `NAT`
- é™åˆ¶é”¥å½¢`NAT`ï¼Œå®ƒä¹Ÿæ˜¯æ‰€æœ‰ä»åŒä¸€ä¸ªå†…ç½‘IPå’Œç«¯å£å·å‘é€è¿‡æ¥çš„è¯·æ±‚éƒ½ä¼šè¢«æ˜ å°„æˆåŒä¸€ä¸ªå¤–ç½‘IPå’Œç«¯å£å·ã€‚ä¸å®Œå…¨é”¥å½¢ä¸åŒçš„æ˜¯ï¼Œå¤–ç½‘ä¸»æœºåªèƒ½å¤Ÿå‘å…ˆå‰å·²ç»å‘å®ƒå‘é€è¿‡æ•°æ®åŒ…çš„å†…ç½‘ä¸»æœºå‘é€åŒ…ã€‚
![é™åˆ¶å½¢NAT](./resrictednat.png)

              
            
3. Port-restricted cone `NAT`
- ç«¯å£é™åˆ¶é”¥å½¢`NAT`ï¼Œä¸é™åˆ¶é”¥å½¢`NAT`å¾ˆç›¸ä¼¼ï¼Œåªä¸è¿‡å®ƒåŒ…æ‹¬ç«¯å£å·ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œä¸€å°IPåœ°å€Xå’Œç«¯å£Pçš„å¤–ç½‘ä¸»æœºæƒ³ç»™å†…ç½‘ä¸»æœºå‘é€åŒ…ï¼Œå¿…é¡»æ˜¯è¿™å°å†…ç½‘ä¸»æœºå…ˆå‰å·²ç»ç»™è¿™ä¸ªIPåœ°å€Xå’Œç«¯å£På‘é€è¿‡æ•°æ®åŒ…ã€‚
![ç«¯å£é™åˆ¶å½¢NAT](./portrnat.png)
              
            
4. Symmetric `NAT`
- å¯¹ç§°`NAT`ï¼Œæ‰€æœ‰ä»åŒä¸€ä¸ªå†…ç½‘IPå’Œç«¯å£å·å‘é€åˆ°ä¸€ä¸ªç‰¹å®šçš„ç›®çš„IPå’Œç«¯å£å·çš„è¯·æ±‚ï¼Œéƒ½ä¼šè¢«æ˜ å°„åˆ°åŒä¸€ä¸ªIPå’Œç«¯å£å·ã€‚å¦‚æœåŒä¸€å°ä¸»æœºä½¿ç”¨ç›¸åŒçš„æºåœ°å€å’Œç«¯å£å·å‘é€åŒ…ï¼Œä½†æ˜¯å‘å¾€ä¸åŒçš„ç›®çš„åœ°ï¼Œ`NAT`å°†ä¼šä½¿ç”¨ä¸åŒçš„æ˜ å°„ã€‚æ­¤å¤–ï¼Œåªæœ‰æ”¶åˆ°æ•°æ®çš„å¤–ç½‘ä¸»æœºæ‰å¯ä»¥åè¿‡æ¥å‘å†…ç½‘ä¸»æœºå‘é€åŒ…ã€‚
![å¯¹ç§°å‹NAT](./snat.png)
              
            
#### æ–¹æ¡ˆ
ä¸€æ—¦å®¢æˆ·ç«¯å¾—çŸ¥äº†Internetç«¯çš„UDPç«¯å£ï¼Œé€šä¿¡å°±å¯ä»¥å¼€å§‹äº†ã€‚å¦‚æœ`NAT`æ˜¯å®Œå…¨åœ†é”¥å‹çš„ï¼Œé‚£ä¹ˆåŒæ–¹ä¸­çš„ä»»ä½•ä¸€æ–¹éƒ½å¯ä»¥å‘èµ·é€šä¿¡ã€‚å¦‚æœ`NAT`æ˜¯å—é™åœ†é”¥å‹æˆ–ç«¯å£å—é™åœ†é”¥å‹ï¼ŒåŒæ–¹å¿…é¡»ä¸€èµ·å¼€å§‹ä¼ è¾“ã€‚

éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œè¦ä½¿ç”¨`STUN` RFCä¸­æè¿°çš„æŠ€æœ¯å¹¶ä¸ä¸€å®šéœ€è¦ä½¿ç”¨`STUN`åè®®ï¼Œè¿˜å¯ä»¥å¦å¤–è®¾è®¡ä¸€ä¸ªåè®®å¹¶æŠŠç›¸åŒçš„åŠŸèƒ½é›†æˆåˆ°è¿è¡Œè¯¥åè®®çš„æœåŠ¡å™¨ï¼ˆ`TURN`ï¼‰ä¸Šã€‚

SIPä¹‹ç±»çš„åè®®æ˜¯ä½¿ç”¨UDPåˆ†ç»„åœ¨Internetä¸Šä¼ è¾“éŸ³é¢‘ï¼è§†é¢‘æ•°æ®çš„ã€‚ä¸å¹¸çš„æ˜¯ï¼Œç”±äºé€šä¿¡çš„ä¸¤ä¸ªæœ«ç«¯å¾€å¾€ä½äº`NAT`ä¹‹åï¼Œå› æ­¤ç”¨ä¼ ç»Ÿçš„æ–¹æ³•æ˜¯æ— æ³•åˆ›å»ºè¿æ¥çš„ã€‚è¿™ä¹Ÿå°±æ˜¯`STUN`å‘æŒ¥ä½œç”¨çš„åœ°æ–¹ã€‚

`STUN`æ˜¯ä¸€ä¸ªCSåè®®ã€‚ä¸€ä¸ªVoIPç”µè¯æˆ–è½¯ä»¶åŒ…å¯èƒ½ä¼šåŒ…æ‹¬ä¸€ä¸ª`STUN`å®¢æˆ·ç«¯ï¼Œè€Œ`WebRTC`ä¸­çš„RTCPeerConnectionæ¥å£åˆ™ç»™äºˆäº†æˆ‘ä»¬ç›´æ¥è°ƒç”¨`STUN`æœåŠ¡å™¨çš„èƒ½åŠ›ã€‚è¿™ä¸ªå®¢æˆ·ç«¯ä¼šå‘`STUN`æœåŠ¡å™¨å‘é€è¯·æ±‚ï¼Œä¹‹åï¼ŒæœåŠ¡å™¨å°±ä¼šå‘`STUN`å®¢æˆ·ç«¯æŠ¥å‘Š`NAT`è·¯ç”±å™¨çš„å…¬ç½‘IPåœ°å€ä»¥åŠ`NAT`ä¸ºå…è®¸ä¼ å…¥æµé‡ä¼ å›å†…ç½‘è€Œå¼€é€šçš„ç«¯å£ï¼Œä»¥ç»„è£…æ­£ç¡®çš„UDPæ•°æ®åŒ…ã€‚

ä»¥ä¸Šçš„å“åº”åŒæ—¶è¿˜ä½¿å¾—`STUN`å®¢æˆ·ç«¯èƒ½å¤Ÿç¡®å®šæ­£åœ¨ä½¿ç”¨çš„`NAT`ç±»å‹â€”â€”å› ä¸ºä¸åŒçš„`NAT`ç±»å‹å¤„ç†ä¼ å…¥çš„UDPåˆ†ç»„çš„æ–¹å¼æ˜¯ä¸åŒçš„ã€‚å››ç§ä¸»è¦ç±»å‹ä¸­æœ‰ä¸‰ç§æ˜¯å¯ä»¥ä½¿ç”¨çš„ï¼šå®Œå…¨åœ†é”¥å‹`NAT`ã€å—é™åœ†é”¥å‹`NAT`å’Œç«¯å£å—é™åœ†é”¥å‹`NAT`â€”â€”ä½†å¤§å‹å…¬å¸ç½‘ç»œä¸­ç»å¸¸é‡‡ç”¨çš„å¯¹ç§°å‹`NAT`ï¼ˆåˆç§°ä¸ºåŒå‘`NAT`ï¼‰åˆ™ä¸èƒ½ä½¿ç”¨ã€‚

#### ç®—æ³•
![ç®—æ³•](./stunmath.png)

            
æ³¨ï¼šä¸€æ—¦è·¯ç»é€šè¿‡çº¢è‰²ç®±å­çš„ç»ˆç‚¹æ—¶ï¼ŒUDPçš„æ²Ÿé€šæ˜¯æ²¡æœ‰å¯èƒ½æ€§çš„ã€‚ä¸€æ—¦é€šè¿‡é»„è‰²æˆ–æ˜¯ç»¿è‰²çš„ç®±å­ï¼Œå°±æœ‰è¿çº¿çš„å¯èƒ½ã€‚

### `TURN`åè®®
ä½¿ç”¨`TURN`åè®®å¯ä»¥ç©¿é€å¯¹ç§°å‹`NAT`ã€‚`TURN`åè®®å…è®¸ä¸€å°ä¸»æœºä½¿ç”¨ä¸­ç»§æœåŠ¡ä¸å¯¹ç«¯è¿›è¡ŒæŠ¥æ–‡ä¼ è¾“ã€‚`TURN`ä¸åŒäºå…¶å®ƒä¸­ç»§åè®®åœ¨äºå®ƒå…è®¸å®¢æˆ·æœºä½¿ç”¨ä¸€ä¸ªä¸­ç»§åœ°å€ä¸å¤šä¸ªå¯¹ç«¯åŒæ—¶è¿›è¡Œé€šè®¯ã€‚å®Œç¾å¼¥è¡¥äº†`STUN`æ— æ³•ç©¿é€å¯¹ç§°å‹`NAT`çš„ç¼ºé™·ã€‚

> RTCPeerConnectionå°è¯•é€šè¿‡UDPå»ºç«‹å¯¹ç­‰ç«¯ä¹‹é—´çš„ç›´æ¥é€šä¿¡ã€‚
  å¦‚æœå¤±è´¥çš„è¯ï¼ŒRTCPeerConnectionå°±ä¼šä½¿ç”¨TCPè¿›è¡Œè¿æ¥ã€‚å¦‚æœä½¿ç”¨TCPè¿˜å¤±è´¥çš„è¯ï¼Œå¯ä»¥ç”¨ `TURN`æœåŠ¡å™¨ä½œä¸ºåå¤‡ï¼Œåœ¨ç»ˆç«¯ä¹‹é—´è½¬å‘æ•°æ®ã€‚
  é‡ç”³ï¼š `TURN`ç”¨äºä¸­ç»§å¯¹ç­‰ç«¯ä¹‹é—´çš„éŸ³é¢‘/è§†é¢‘/æ•°æ®æµ
  `TURN`æœåŠ¡å™¨å…·æœ‰å…¬å…±åœ°å€ï¼Œå› æ­¤å³ä½¿å¯¹ç­‰ç«¯ä½äºé˜²ç«å¢™æˆ–ä»£ç†ä¹‹åä¹Ÿå¯ä»¥ä¸å…¶ä»–äººè”ç³»ã€‚ `TURN`æœåŠ¡å™¨æœ‰ä¸€ä¸ªæ¦‚å¿µä¸Šæ¥è®²ç®€å•çš„ä»»åŠ¡â€”ä¸­ç»§æ•°æ®æµâ€”ä½†æ˜¯ä¸ `STUN`æœåŠ¡å™¨ä¸åŒçš„æ˜¯ï¼Œä»–ä»¬ä¼šæ¶ˆè€—å¤§é‡çš„å¸¦å®½ã€‚æ¢å¥è¯è¯´ï¼Œ `TURN`æœåŠ¡å™¨éœ€è¦æ›´åŠ çš„å¼ºå¤§ã€‚

å…·ä½“åŸç†ä¿ºæ¥ä¸‹æ¥æœ‰æœºä¼šå†å»æ·±å…¥ï¼Œè¿™æ¬¡æ¢ç©¶çš„é‡ç‚¹å¹¶ä¸åœ¨è¿™é‡Œã€‚
ä½†é‡è¦çš„æ˜¯ï¼Œé€šè¿‡è¿™ä¸¤ä¸ªåè®®ï¼Œæˆ‘ä»¬å¯ä»¥è½»è€Œæ˜“ä¸¾çš„è·å–å½“å‰ç«¯çš„å¤–ç½‘IPåœ°å€æ˜ å°„äº†ã€‚

### éƒ¨ç½²`STUN`å’Œ`TURN`æœåŠ¡
æ³¨æ„`STUN`æœåŠ¡å¿…é¡»éƒ¨ç½²åœ¨æ‹¥æœ‰å”¯ä¸€å…¬ç½‘IPçš„è®¾å¤‡ä¸Šã€‚ä¿ºé€‰æ‹©äº†é˜¿é‡Œäº‘ECSè¿›è¡Œå®éªŒã€‚
- `STUN`å’Œ `TURN`æœåŠ¡å™¨çš„æºä»£ç å¯ä»code.google.com/p/rfc5766-turn-serverè·å¾—ï¼Œè¯¥ä»£ç è¿˜æä¾›äº†æœ‰å…³æœåŠ¡å™¨å®‰è£…çš„å¤šä¸ªä¿¡æ¯æºçš„é“¾æ¥ã€‚
- Amazon Web Servicesçš„VMæ˜ åƒä¹Ÿå¯ç”¨ã€‚
- å¦ä¸€ä¸ª `TURN`æœåŠ¡å™¨æ˜¯restundï¼Œæä¾›æºä»£ç ï¼Œä¹Ÿæœ‰AWSæœåŠ¡ã€‚

ä¿ºè¿™é‡Œæ¢ç©¶äº†å¦ä¸€æ¬¾`STUN`æœåŠ¡ï¼Œcoturnï¼š
coturn æœåŠ¡å™¨å®Œæ•´çš„å®ç°äº† `STUN`/`TURN` åè®®ï¼Œæ”¯æŒ P2P ç©¿é€é˜²ç«å¢™ï¼›
coturn æ”¯æŒ TCP, UDP, TLS, DTLSè¿æ¥ï¼›æ”¯æŒ Linuxã€macOSï¼Œæš‚ä¸æ”¯æŒWindowsã€‚

éƒ¨ç½²æ­¥éª¤ï¼š

#### é˜¿é‡Œäº‘é¢æ¿é…ç½®
1. åœ¨å®‰å…¨ç»„ä¸­å¼€å¯3478ç«¯å£UDPå‡ºå…¥è§„åˆ™ï¼Œå¦‚ä¸‹å›¾ï¼š
![å‡ºå…¥è§„åˆ™](./firewall.png)
            
2. æŸ¥çœ‹å®ä¾‹å†…ç½‘IP/å¤–ç½‘IPå¹¶è®°å½•ï¼š
![IP check](./ipipip.png)
              
#### ECSå®ä¾‹éƒ¨ç½²æœåŠ¡
1. git clone / configure / make / make install å››è¿
```bash
git clone 'https://github.com/coturn/coturn cd coturn'
./configure 
make 
sudo make install

yum install libevent-devel # å¦‚æœä½ çš„ç”µè„‘ä¸Šæ²¡æœ‰å®‰è£…LibEvent2ï¼Œéœ€è¦å…ˆå®‰è£…libevent-devel
yum -y install openssl-devel # openSSLä¹Ÿè¦å®‰è£…å—·
```
2. é…ç½®æ–‡ä»¶
- åœ¨Coturnç¼–è¯‘å®Œæˆå¥½ä¹‹åä¼šè‡ªåŠ¨ç”Ÿæˆä¸€ä¸ªé…ç½®æ–‡ä»¶æ¨¡ç‰ˆï¼Œè·¯å¾„å¦‚ä¸‹ï¼š`/usr/local/etc/turnserver.conf.default`
- ä¿ºè¿™é‡Œå†™ä¸€ä¸ªæœ€ç®€é…ç½®`turnserver.conf.min`ï¼š
```bash
# server
listening-port=3478 # æœåŠ¡ç›‘å¬ç«¯å£ï¼Œé»˜è®¤ä¹Ÿæ˜¯3478
listening-ip=172.16.205.16 # æœåŠ¡ç›‘å¬çš„å†…ç½‘IP
external-ip=118.178.181.100  # å½“å‰æœåŠ¡çš„å¤–ç½‘IP
realm=stun.neotape.live # åŸŸæ ‡å¿—ï¼Œä¸çŸ¥é“æ˜¯ä»€ä¹ˆæ„æ€ï¼Œå¯ä»¥éšä¾¿å†™
no-tls # å…³æ‰TLSï¼Œæœ€ç®€æœåŠ¡ 
no-dtls # DTLSåŒç†
mobility # è¿™é‡Œä¹Ÿæ²¡æœ‰æ‡‚ï¼Œå¼€å¯Mobility ICEï¼Œå³å…è®¸æµåœ¨å¤šä¸ªè®¾å¤‡é—´ç§»åŠ¨ï¼Ÿ
no-cli # ç¦æ­¢æœ¬åœ° telnet cliç®¡ç†æ¥å£
verbose # æ—¥å¿—è¾“å‡ºè¯¦ç»†æ¨¡å¼
fingerprint # æ¶ˆæ¯éªŒè¯ï¼ŒWebRTC çš„æ¶ˆæ¯é‡Œä¼šç”¨åˆ°
lt-cred-mech # webrtc é€šè¿‡ turn ä¸­ç»§ï¼Œå¿…é¡»ä½¿ç”¨é•¿éªŒè¯æ–¹å¼
stale-nonce=3600 # å¯ä¸º TURN æœåŠ¡æä¾›æ›´å®‰å…¨çš„è®¿é—®
user=neo:tape # è®¾ç½®ä¸€ä¸ªç”¨æˆ·ï¼Œè¿™é‡Œå¯ä»¥è®¾ç½®å¤šä¸ªæˆ–è€…ä½¿ç”¨æ•°æ®åº“
```
 å…¨éƒ¨çš„å‘½ä»¤å’Œé…ç½®è§gitä¸Šcoturnçš„wikiï¼šhttps://github.com/coturn/coturn/wiki/turnserver
3. å¯åŠ¨æœåŠ¡
```bash
turnserver -c turnserver.conf.min # æœåŠ¡å°±å¯åŠ¨äº†ï¼Œå¯ä»¥è§‚å¯Ÿè§‚å¯ŸæœåŠ¡çš„æ—¥å¿—
```
4. éªŒè¯æœåŠ¡æ˜¯å¦å¥½ä½¿
- https://webrtc.github.io/samples/src/content/peerconnection/trickle-ice/
![trace ICE](./tarceice.png)
`TURN`æœåŠ¡éªŒè¯   
![trace ICE](./trace1.png) 
`STUN`æœåŠ¡éªŒè¯
![trace ICE](./trace2.png) 
å¦‚æœå¤±è´¥äº†ï¼Œä¼šå¾—åˆ°ç›¸åº”çš„é”™è¯¯æç¤ºï¼Œæ¯”å¦‚ä¸‹å›¾è¿™ä¸ªTimeouté”™è¯¯ï¼š

ä»¥ä¸Šä¾¿æ˜¯æ˜¯`WebRTC`ä¸­ç»å¸¸ç”¨åˆ°çš„2ä¸ªåè®®ï¼Œ`STUN`å’Œ`TURN`æœåŠ¡å™¨æˆ‘ä»¬ä½¿ç”¨çš„coturnå¼€æºé¡¹ç›®ã€‚è‡³æ­¤ï¼Œè·å–å½“å‰ç«¯çš„å¤–ç½‘IPåœ°å€æ˜ å°„çš„ä»»åŠ¡å®Œæˆäº†ã€‚

æ³¨æ˜ä¸€ç‚¹ï¼šICEè·Ÿ`STUN`å’Œ`TURN`ä¸ä¸€æ ·ï¼ŒICEä¸æ˜¯ä¸€ç§åè®®ï¼Œè€Œæ˜¯ä¸€ä¸ªæ¡†æ¶ï¼ˆFrameworkï¼‰ï¼Œå®ƒæ•´åˆäº†`STUN`å’Œ`TURN`ã€‚coturnå¼€æºé¡¹ç›®é›†æˆäº†`STUN`å’Œ`TURN`çš„åŠŸèƒ½ã€‚

### äº¤æ¢ç½‘ç»œä¿¡æ¯
åœ¨`WebRTC`ä¸­ç”¨æ¥æè¿° ç½‘ç»œä¿¡æ¯çš„æœ¯è¯­å«candidateã€‚

ç„¶åæˆ‘ä»¬éœ€è¦ä½¿ç”¨ä¿¡ä»¤æœåŠ¡æ¥å¯¹ä¸¤ç«¯ä¹‹é—´çš„candidateä¿¡æ¯åšäº¤æ¢ï¼š
```javascript
// å’Œä¸Šè¿°ä¾‹å­æ¯”ï¼Œå¤šåšäº†ä¸€äº›å¾®å°çš„å·¥ä½œ
const signaling = new SignalingChannel();
// é…ç½®è¿‡çš„STUNæœåŠ¡
const configuration = {iceServers: [{urls: 'stuns:stun.example.org'}]};
// åˆ›å»ºRTCPeerConnectionçš„æ—¶å€™ä¾¿å¯æŠŠSTUN/TURNçš„é…ç½®ä¸€å¹¶å†™åœ¨å…¶ä¸­
const pc = new RTCPeerConnection(configuration);
// æœ¬åœ°ä»£ç†ICEéœ€è¦é€šè¿‡ä¿¡ä»¤æœåŠ¡å™¨ä¼ é€’ä¿¡æ¯ç»™å…¶ä»–å¯¹ç­‰ç«¯æ—¶å°±ä¼šè§¦å‘
pc.onicecandidate = ({candidate}) => signaling.send({candidate});
pc.onnegotiationneeded = async () => {
  try {
    await pc.setLocalDescription(await pc.createOffer());
    signaling.send({desc: pc.localDescription});
  } catch (err) {
    console.error(err);
  }};

signaling.onmessage = async ({desc, candidate}) => {
  try {
    if (desc) {
      if (desc.type === 'offer') {
        await pc.setRemoteDescription(desc);
        const stream =
          await navigator.mediaDevices.getUserMedia(constraints);
        stream.getTracks().forEach((track) =>
          pc.addTrack(track, stream));
        await pc.setLocalDescription(await pc.createAnswer());
        signaling.send({desc: pc.localDescription});
      } else if (desc.type === 'answer') {
        await pc.setRemoteDescription(desc);
      } else {
        console.log('Unsupported SDP type.');
      }
    } else if (candidate) {
      // è·å–å¯¹ç«¯çš„candidateä¿¡æ¯ï¼Œåšä¸€ä¸ªä¿å­˜ï¼Œæ­¤æ—¶è¿æ¥å·²ç»æ­£å¸¸å»ºç«‹
      await pc.addIceCandidate(candidate);
    }
  } catch (err) {
    console.error(err);
  }};
```
## ä¿¡ä»¤æœåŠ¡å™¨
`WebRTC`ä¸­é—´æ— æ³•åˆ›å»ºæ²¡æœ‰æŸç§æœåŠ¡å™¨çš„è¿æ¥ã€‚ æˆ‘ä»¬ç§°ä¹‹ä¸ºä¿¡å·é€šé“ï¼ˆä¿¡ä»¤ï¼‰ã€‚ æ— è®ºæ˜¯é€šè¿‡ç”µå­é‚®ä»¶ï¼Œæ˜ä¿¡ç‰‡è¿˜æ˜¯ä¸€åªä¿¡é¸½...ï¼Œéƒ½å¯ä»¥é€šè¿‡ä»»ä½•é€šä¿¡æ–¹å¼äº¤æ¢ä¿¡æ¯ï¼Œè¿™å–å†³äºä½ ã€‚ä¸è¿‡è¿™ä¹Ÿæ°æ°å¯¼è‡´å»ºç«‹ä¿¡ä»¤æœåŠ¡çš„æ–¹å¼çš„å¤šæ ·æ€§ï¼Œåªè¦èƒ½ä¿è¯è¦è¿›è¡ŒRTCçš„ä¸¤ç«¯èƒ½æ­£ç¡®æ¥æ”¶åˆ°å½¼æ­¤çš„`SDP`ä»¥åŠcandidateå¹¶ä¿å­˜å³å¯ã€‚ä¿ºç”¨socket.ioæ¥å®ç°ç®€å•çš„ä¿¡ä»¤æœåŠ¡ï¼š
```javascript
const os = require('os'); // operating system lib
const nss = require('node-static'); // node-static-server lib
const http = require('http'); // node http lib
const socketIO = require('socket.io'); // socket.io lib

const fs = new (nss.Server)('./server/template'); // fs here is not file system :( but file server :) anyway

// create an server
const app = http.createServer((req, res) => {
    fs.serve(req, res);
}).listen(8080);

const io = socketIO.listen(app); // load socket.io listening to http server created before

// when io found client connected
io.sockets.on('connection', function (socket) {

    // convenience func to notify server messages to the client
    function notify() {
        let array = ['[[[Server Notifications]]]:']; // init message list
        array.push.apply(array, arguments); // push args to message list
        socket.emit('notify', array); // emit messages
    }

    // got message then resend to other client
    socket.on('message', function (message) {
        notify('Client said:', message);
        socket.broadcast.emit('message', message); // broadcast the message to other clients, but here maximum client nums is 2
    });

    socket.on('create or join', function (room) {
        notify('Received request to create or join room: ' + room);
        let clientsInRoom = io.sockets.adapter.rooms[room]; // found members in room now
        let nums = clientsInRoom ? Object.keys(clientsInRoom.sockets).length : 0;
        notify(`Room ${room} now has ${nums} client(s)`);

        // if no members in current room
        if (nums === 0) {
            socket.join(room); // create new room
            notify(`Client ID ${socket.id} created room ${room}`);
            socket.emit('created', room, socket.id); // emit signal to client that room created successfully
        } else if (nums === 1) {
            notify(`Client ID ${socket.id} joined room ${room}`);
            io.sockets.in(room).emit('join', room); // emit join signal to the peer now in the room
            socket.join(room); // join to the room
            socket.emit('joined', room, socket.id); // emit signal to client that room joined successfully
            io.sockets.in(room).emit('ready'); // when both of two clients are here in room now, emit ready to both of them
        } else { // max two clients
            socket.emit('full', room);
        }
    });

    socket.on('ipaddr', function () {
        const ifaces = os.networkInterfaces(); // get network interfaces
        for (let dev in ifaces) {
            ifaces[dev].forEach(function (details) {
                if (details.family === '`IPv4`' && details.address !== '127.0.0.1') {
                    socket.emit('ipaddr', details.address); // emit server ip address to socket
                }
            })
        }
    });

    // bye handler
    socket.on('bye', function () {
        console.log('received bye from client');
        notify('bye~');
    });
});
```
## æ€»ç»“
![æ€»ç»“](./finalstun.png)
é€šè¿‡ä¿¡ä»¤æœåŠ¡ã€`STUN`&`TURN`æœåŠ¡ï¼Œæˆ‘ä»¬ä¾¿å¯ä»¥å®Œæˆ`WebRTC`é€šè¯å»ºç«‹çš„å…¨éƒ¨è¿‡ç¨‹ã€‚ä¸Šå›¾ä¾¿ç®€å•çš„åæ˜ äº†å»ºç«‹è¿æ¥çš„å¤§ä½“æƒ…å†µã€‚

`WebRTC Javascript APIs`
- getUserMedia()ï¼šæ•æ‰éŸ³é¢‘å’Œè§†é¢‘
- RTCPeerConnectionï¼šåœ¨ç”¨æˆ·ä¹‹é—´æµå¼ä¼ è¾“éŸ³é¢‘å’Œè§†é¢‘
- RTCDataChannelï¼šåœ¨ç”¨æˆ·ä¹‹é—´ä¼ è¾“æ•°æ®
- MediaRecorderï¼šå½•åˆ¶éŸ³é¢‘å’Œè§†é¢‘

åˆ©ç”¨è¿™äº›APIï¼Œæˆ‘ä»¬å¯ä»¥åœ¨Webå®ç°å¾ˆå¤šæœ‰è¶£çš„RTCåŠŸèƒ½ã€‚

# `WebRTC`æµè§ˆå™¨å…¼å®¹æ€§ â€”â€”webrtc-adapter
## ç”±æ¥
> adapter.jsè‡ª2012å¹´åº•æˆ–è€…2013å¹´åˆ`WebRTC`æ—©æœŸçš„æ—¶å€™å°±å·²ç»å‡ºç°äº†ã€‚å®ƒæ˜¯ä¸€ä¸ªéå¸¸å°çš„é¡¹ç›®ï¼Œå½“æ—¶è¿˜æ²¡æœ‰150è¡Œã€‚ä¸»è¦åŠŸèƒ½æ˜¯éšè—åƒwebkitRTCPeerConnectionå’ŒmozRTCPeerConnectionè¿™æ ·çš„å‰ç¼€å·®å¼‚ï¼Œå¹¶æä¾›å‡½æ•°å°†MediaStreamé™„åŠ åˆ°HTMLçš„æˆ–å…ƒç´ ã€‚éšç€å„ä¸ªæ¸¸è§ˆå™¨å¯¹webrtcçš„æ”¯æŒï¼Œ adapter.jsç”¨æ¥å±è”½å„ä¸ªæ¸¸è§ˆå™¨ä¹‹é—´çš„å·®å¼‚ï¼Œå¯¹å¤–æä¾›ç»Ÿä¸€çš„æ¥å£ï¼Œå…¶å¤æ‚ç¨‹åº¦ä¹Ÿè¶Šæ¥è¶Šé«˜ï¼Œç›®å‰è¶…è¿‡2200è¡Œä»£ç ã€‚ 
## ä½¿ç”¨
- https://www.npmjs.com/package/webrtc-adapter æ¨¡å—å¼•å…¥
- https://webrtc.github.io/adapter/adapter-latest.js è„šæœ¬å¼•å…¥
# `WebRTC` éŸ³è§†é¢‘é€šè¯
## å®‰å…¨æºé™åˆ¶
ç”±äºä¸»æµæµè§ˆå™¨å®‰å…¨æºç­–ç•¥çš„é—®é¢˜ï¼Œè‹¥è®¿é—®çš„åœ°å€éæœ¬åœ°ä¸»æœºæˆ–HTTPSåœ°å€ï¼ŒéŸ³è§†é¢‘èƒ½åŠ›ä¸`WebRTC` Javascript APIé»˜è®¤æ— æ³•è·å¾—ã€‚è§£å†³æ–¹æ¡ˆæœ‰ä¸¤ä¸ªï¼š
1. ä½¿ç”¨ç»ˆç«¯å¼€å¯chromeå¹¶æ·»åŠ   --unsafely-treat-insecure-origin-as-secure="http://xxx"å‘½ä»¤
2. ä½¿ç”¨httpsï¼ˆWebSocketåˆ™è¿˜éœ€å¼€å¯wssï¼‰ 
- æ¯”å¦‚ä¿ºï¼Œä¿ºç”¨nginxè½¬å‘443ç«¯å£åˆ°nodeæœåŠ¡ï¼Œå› æ­¤è¿˜éœ€è¦å¯¹wsåšé¢å¤–çš„è½¬å‘ï¼š
location /ws/ {
    proxy_pass http://127.0.0.1:8080;
    proxy_http_version 1.1;
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection "upgrade";
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
}
## getUserMedia API
### ç®€ä»‹  

MediaDevices.getUserMedia() ä¼šæç¤ºç”¨æˆ·ç»™äºˆä½¿ç”¨åª’ä½“è¾“å…¥çš„è®¸å¯ï¼Œåª’ä½“è¾“å…¥ä¼šäº§ç”Ÿä¸€ä¸ªMediaStreamï¼Œé‡Œé¢åŒ…å«äº†è¯·æ±‚çš„åª’ä½“ç±»å‹çš„è½¨é“ã€‚æ­¤æµå¯ä»¥åŒ…å«ä¸€ä¸ªè§†é¢‘è½¨é“ï¼ˆæ¥è‡ªç¡¬ä»¶æˆ–è€…è™šæ‹Ÿè§†é¢‘æºï¼Œæ¯”å¦‚ç›¸æœºã€è§†é¢‘é‡‡é›†è®¾å¤‡å’Œå±å¹•å…±äº«æœåŠ¡ç­‰ç­‰ï¼‰ã€ä¸€ä¸ªéŸ³é¢‘è½¨é“ï¼ˆåŒæ ·æ¥è‡ªç¡¬ä»¶æˆ–è™šæ‹ŸéŸ³é¢‘æºï¼Œæ¯”å¦‚éº¦å…‹é£ã€A/Dè½¬æ¢å™¨ç­‰ç­‰ï¼‰ï¼Œä¹Ÿå¯èƒ½æ˜¯å…¶å®ƒè½¨é“ç±»å‹ã€‚  

å®ƒè¿”å›ä¸€ä¸ª Promise å¯¹è±¡ï¼ŒæˆåŠŸåä¼šresolveå›è°ƒä¸€ä¸ª MediaStream å¯¹è±¡ã€‚è‹¥ç”¨æˆ·æ‹’ç»äº†ä½¿ç”¨æƒé™ï¼Œæˆ–è€…éœ€è¦çš„åª’ä½“æºä¸å¯ç”¨ï¼Œpromiseä¼šrejectå›è°ƒä¸€ä¸ª  PermissionDeniedError æˆ–è€… NotFoundError ã€‚  

è¿”å›çš„promiseå¯¹è±¡å¯èƒ½æ—¢ä¸ä¼šresolveä¹Ÿä¸ä¼šrejectï¼Œå› ä¸ºç”¨æˆ·ä¸æ˜¯å¿…é¡»é€‰æ‹©å…è®¸æˆ–æ‹’ç»ã€‚  

é€šå¸¸ä½ å¯ä»¥ä½¿ç”¨ navigator.mediaDevices æ¥è·å– MediaDevices ï¼Œä¾‹å¦‚ï¼š  

```javascript
navigator.mediaDevices.getUserMedia(constraints)
.then(function(stream) {
  /* ä½¿ç”¨è¿™ä¸ªstream stream */
})
.catch(function(err) {
  /* å¤„ç†error */
});
```

###  è¯­æ³•  

```javascript
var promise = navigator.mediaDevices.getUserMedia(constraints)
```

### å‚æ•°  

**constraints**ï¼Œ  

ä½œä¸ºä¸€ä¸ªMediaStreamConstraints å¯¹è±¡ï¼ŒæŒ‡å®šäº†è¯·æ±‚çš„åª’ä½“ç±»å‹å’Œç›¸å¯¹åº”çš„å‚æ•°ã€‚  

`constraints` å‚æ•°æ˜¯ä¸€ä¸ªåŒ…å«äº†`video` å’Œ `audio`ä¸¤ä¸ªæˆå‘˜çš„MediaStreamConstraints å¯¹è±¡ï¼Œç”¨äºè¯´æ˜è¯·æ±‚çš„åª’ä½“ç±»å‹ã€‚å¿…é¡»è‡³å°‘ä¸€ä¸ªç±»å‹æˆ–è€…ä¸¤ä¸ªåŒæ—¶å¯ä»¥è¢«æŒ‡å®šã€‚å¦‚æœæµè§ˆå™¨æ— æ³•æ‰¾åˆ°æŒ‡å®šçš„åª’ä½“ç±»å‹æˆ–è€…æ— æ³•æ»¡è¶³ç›¸å¯¹åº”çš„å‚æ•°è¦æ±‚ï¼Œé‚£ä¹ˆè¿”å›çš„Promiseå¯¹è±¡å°±ä¼šå¤„äºrejectedï¼»å¤±è´¥ï¼½çŠ¶æ€ï¼ŒNotFoundErrorä½œä¸ºrejectedï¼»å¤±è´¥ï¼½å›è°ƒçš„å‚æ•°ã€‚   

ä»¥ä¸‹åŒæ—¶è¯·æ±‚ä¸å¸¦ä»»ä½•å‚æ•°çš„éŸ³é¢‘å’Œè§†é¢‘ï¼š`{ audio: true, video: true }`  

å¦‚æœä¸ºæŸç§åª’ä½“ç±»å‹è®¾ç½®äº† true ï¼Œå¾—åˆ°çš„ç»“æœçš„æµä¸­å°±éœ€è¦æœ‰æ­¤ç§ç±»å‹çš„è½¨é“ã€‚å¦‚æœå…¶ä¸­ä¸€ä¸ªç”±äºæŸç§åŸå› æ— æ³•è·å¾—ï¼ŒgetUserMedia() å°†ä¼šäº§ç”Ÿä¸€ä¸ªé”™è¯¯ã€‚  

å½“ç”±äºéšç§ä¿æŠ¤çš„åŸå› ï¼Œæ— æ³•è®¿é—®ç”¨æˆ·çš„æ‘„åƒå¤´å’Œéº¦å…‹é£ä¿¡æ¯æ—¶ï¼Œåº”ç”¨å¯ä»¥ä½¿ç”¨é¢å¤–çš„constraintså‚æ•°è¯·æ±‚å®ƒæ‰€éœ€è¦æˆ–è€…æƒ³è¦çš„æ‘„åƒå¤´å’Œéº¦å…‹é£èƒ½åŠ›ã€‚ä¸‹é¢æ¼”ç¤ºäº†åº”ç”¨æƒ³è¦ä½¿ç”¨1280x720çš„æ‘„åƒå¤´åˆ†è¾¨ç‡ï¼š  

```javascript
{
  audio: true,
  video: { width: 1280, height: 720 }
}
```

æµè§ˆå™¨ä¼šè¯•ç€æ»¡è¶³è¿™ä¸ªè¯·æ±‚å‚æ•°ï¼Œä½†æ˜¯å¦‚æœæ— æ³•å‡†ç¡®æ»¡è¶³æ­¤è¯·æ±‚ä¸­å‚æ•°è¦æ±‚æˆ–è€…ç”¨æˆ·é€‰æ‹©è¦†ç›–äº†è¯·æ±‚ä¸­çš„å‚æ•°æ—¶ï¼Œæœ‰å¯èƒ½è¿”å›å…¶å®ƒçš„åˆ†è¾¨ç‡ã€‚  

å¼ºåˆ¶è¦æ±‚è·å–ç‰¹å®šçš„å°ºå¯¸æ—¶ï¼Œå¯ä»¥ä½¿ç”¨å…³é”®å­—min, max, æˆ–è€… exact(å°±æ˜¯ min == max). ä»¥ä¸‹å‚æ•°è¡¨ç¤ºè¦æ±‚è·å–æœ€ä½ä¸º1280x720çš„åˆ†è¾¨ç‡ã€‚  

```javascript
{
  audio: true,
  video: {
    width: { min: 1280 },
    height: { min: 720 }
  }
}
```

å¦‚æœæ‘„åƒå¤´ä¸æ”¯æŒè¯·æ±‚çš„æˆ–è€…æ›´é«˜çš„åˆ†è¾¨ç‡ï¼Œè¿”å›çš„Promiseä¼šå¤„äºrejectedçŠ¶æ€ï¼ŒNotFoundErrorä½œä¸ºrejectedå›è°ƒçš„å‚æ•°ï¼Œè€Œä¸”ç”¨æˆ·å°†ä¸ä¼šå¾—åˆ°è¦æ±‚æˆæƒçš„æç¤ºã€‚  

é€ æˆä¸åŒè¡¨ç°çš„åŸå› æ˜¯ï¼Œç›¸å¯¹äºç®€å•çš„è¯·æ±‚å€¼å’Œidealå…³é”®å­—è€Œè¨€ï¼Œå…³é”®å­—min, max, å’Œ exactæœ‰ç€å†…åœ¨å…³è”çš„å¼ºåˆ¶æ€§ï¼Œè¯·çœ‹ä¸€ä¸ªæ›´è¯¦ç»†çš„ä¾‹å­ï¼š  

```javascript
{
  audio: true,
  video: {
    width: { min: 1024, ideal: 1280, max: 1920 },
    height: { min: 776, ideal: 720, max: 1080 }
  }
}
```

å½“è¯·æ±‚åŒ…å«ä¸€ä¸ªidealï¼ˆåº”ç”¨æœ€ç†æƒ³çš„ï¼‰å€¼æ—¶ï¼Œè¿™ä¸ªå€¼æœ‰ç€æ›´é«˜çš„æƒé‡ï¼Œæ„å‘³ç€æµè§ˆå™¨ä¼šå…ˆå°è¯•æ‰¾åˆ°æœ€æ¥è¿‘æŒ‡å®šçš„ç†æƒ³å€¼çš„è®¾å®šæˆ–è€…æ‘„åƒå¤´ï¼ˆå¦‚æœè®¾å¤‡æ‹¥æœ‰ä¸æ­¢ä¸€ä¸ªæ‘„åƒå¤´ï¼‰ã€‚  

ç®€å•çš„è¯·æ±‚å€¼ä¹Ÿå¯ä»¥ç†è§£ä¸ºæ˜¯åº”ç”¨ç†æƒ³çš„å€¼ï¼Œå› æ­¤æˆ‘ä»¬çš„ç¬¬ä¸€ä¸ªæŒ‡å®šåˆ†è¾¨ç‡çš„è¯·æ±‚ä¹Ÿå¯ä»¥å†™æˆå¦‚ä¸‹ï¼š  

```javascript
{
  audio: true,
  video: {
    width: { ideal: 1280 },
    height: { ideal: 720 }
  }
}
```

å¹¶ä¸æ˜¯æ‰€æœ‰çš„constraints éƒ½æ˜¯æ•°å­—ã€‚ä¾‹å¦‚, åœ¨ç§»åŠ¨è®¾å¤‡ä¸Šé¢ï¼Œå¦‚ä¸‹çš„ä¾‹å­è¡¨ç¤ºä¼˜å…ˆä½¿ç”¨å‰ç½®æ‘„åƒå¤´ï¼ˆå¦‚æœæœ‰çš„è¯ï¼‰ï¼š  

```javascript
{ audio: true, video: { facingMode: "user" } }
```

å¼ºåˆ¶ä½¿ç”¨åç½®æ‘„åƒå¤´ï¼Œè¯·ç”¨ï¼š  

```javascript
{ audio: true, video: { facingMode: { exact: "environment" } } }
```

### è¿”å›å€¼  

è¿”å›ä¸€ä¸ª [Promise](https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/Promise) ï¼Œ è¿™ä¸ªPromiseæˆåŠŸåçš„å›è°ƒå‡½æ•°å¸¦ä¸€ä¸ª [MediaStream](https://developer.mozilla.org/zh-CN/docs/Web/API/MediaStream) å¯¹è±¡ä½œä¸ºå…¶å‚æ•°ã€‚  

### å¼‚å¸¸  

è¿”å›ä¸€ä¸ªå¤±è´¥çŠ¶æ€çš„Promiseï¼Œè¿™ä¸ªPromiseå¤±è´¥åçš„å›è°ƒå‡½æ•°å¸¦ä¸€ä¸ªDOMExceptionå¯¹è±¡ä½œä¸ºå…¶å‚æ•°ã€‚ å¯èƒ½çš„å¼‚å¸¸æœ‰ï¼š  

* AbortErrorï¼»ä¸­æ­¢é”™è¯¯ï¼½  
  å°½ç®¡ç”¨æˆ·å’Œæ“ä½œç³»ç»Ÿéƒ½æˆäºˆäº†è®¿é—®è®¾å¤‡ç¡¬ä»¶çš„æƒåˆ©ï¼Œè€Œä¸”æœªå‡ºç°å¯èƒ½æŠ›å‡ºNotReadableErrorå¼‚å¸¸çš„ç¡¬ä»¶é—®é¢˜ï¼Œä½†ä»ç„¶æœ‰ä¸€äº›é—®é¢˜çš„å‡ºç°å¯¼è‡´äº†è®¾å¤‡æ— æ³•è¢«ä½¿ç”¨ã€‚  

* NotAllowedErrorï¼»æ‹’ç»é”™è¯¯ï¼½
  ç”¨æˆ·æ‹’ç»äº†å½“å‰çš„æµè§ˆå™¨å®ä¾‹çš„è®¿é—®è¯·æ±‚ï¼›æˆ–è€…ç”¨æˆ·æ‹’ç»äº†å½“å‰ä¼šè¯çš„è®¿é—®ï¼›æˆ–è€…ç”¨æˆ·åœ¨å…¨å±€èŒƒå›´å†…æ‹’ç»äº†æ‰€æœ‰åª’ä½“è®¿é—®è¯·æ±‚ã€‚  
  è¾ƒæ—§ç‰ˆæœ¬çš„è§„èŒƒä½¿ç”¨äº†SecurityErrorï¼Œä½†åœ¨æ–°ç‰ˆæœ¬å½“ä¸­SecurityErrorè¢«èµ‹äºˆäº†æ–°çš„æ„ä¹‰ã€‚  

* NotFoundErrorï¼»æ‰¾ä¸åˆ°é”™è¯¯ï¼½  
  æ‰¾ä¸åˆ°æ»¡è¶³è¯·æ±‚å‚æ•°çš„åª’ä½“ç±»å‹ã€‚  

* NotReadableErrorï¼»æ— æ³•è¯»å–é”™è¯¯ï¼½  
  å°½ç®¡ç”¨æˆ·å·²ç»æˆæƒä½¿ç”¨ç›¸åº”çš„è®¾å¤‡ï¼Œæ“ä½œç³»ç»Ÿä¸ŠæŸä¸ªç¡¬ä»¶ã€æµè§ˆå™¨æˆ–è€…ç½‘é¡µå±‚é¢å‘ç”Ÿçš„é”™è¯¯å¯¼è‡´è®¾å¤‡æ— æ³•è¢«è®¿é—®ã€‚  

* OverConstrainedErrorï¼»æ— æ³•æ»¡è¶³è¦æ±‚é”™è¯¯ï¼½  
  æŒ‡å®šçš„è¦æ±‚æ— æ³•è¢«è®¾å¤‡æ»¡è¶³ï¼Œæ­¤å¼‚å¸¸æ˜¯ä¸€ä¸ªç±»å‹ä¸ºOverconstrainedErrorçš„å¯¹è±¡ï¼Œæ‹¥æœ‰ä¸€ä¸ªconstraintå±æ€§ï¼Œè¿™ä¸ªå±æ€§åŒ…å«äº†å½“å‰æ— æ³•è¢«æ»¡è¶³çš„constraintå¯¹è±¡ï¼Œè¿˜æ‹¥æœ‰ä¸€ä¸ªmessageå±æ€§ï¼ŒåŒ…å«äº†é˜…è¯»å‹å¥½çš„å­—ç¬¦ä¸²ç”¨æ¥è¯´æ˜æƒ…å†µã€‚  
  å› ä¸ºè¿™ä¸ªå¼‚å¸¸ç”šè‡³å¯ä»¥åœ¨ç”¨æˆ·å°šæœªæˆæƒä½¿ç”¨å½“å‰è®¾å¤‡çš„æƒ…å†µä¸‹æŠ›å‡ºï¼Œæ‰€ä»¥åº”å½“å¯ä»¥å½“ä½œä¸€ä¸ªæ¢æµ‹è®¾å¤‡èƒ½åŠ›å±æ€§çš„æ‰‹æ®µï¼»fingerprinting surfaceï¼½ã€‚  

* SecurityErrorï¼»å®‰å…¨é”™è¯¯ï¼½  
  åœ¨getUserMedia() è¢«è°ƒç”¨çš„ Document ä¸Šé¢ï¼Œä½¿ç”¨è®¾å¤‡åª’ä½“è¢«ç¦æ­¢ã€‚è¿™ä¸ªæœºåˆ¶æ˜¯å¦å¼€å¯æˆ–è€…å…³é—­å–å†³äºå•ä¸ªç”¨æˆ·çš„åå¥½è®¾ç½®ã€‚  

* TypeErrorï¼»ç±»å‹é”™è¯¯ï¼½  
  constraintså¯¹è±¡æœªè®¾ç½®ï¼»ç©ºï¼½ï¼Œæˆ–è€…éƒ½è¢«è®¾ç½®ä¸ºfalseã€‚  

### ç¤ºä¾‹  

####  å®½åº¦å’Œé«˜åº¦  

è¿™ä¸ªä¾‹å­è®¾ç½®äº†æ‘„åƒå¤´åˆ†è¾¨ç‡ï¼Œå¹¶æŠŠç»“æœçš„ [MediaStream](https://developer.mozilla.org/zh-CN/docs/Web/API/MediaStream) åˆ†é…ç»™äº†ä¸€ä¸ªvideoå…ƒç´ ã€‚  

```javascript
// æƒ³è¦è·å–ä¸€ä¸ªæœ€æ¥è¿‘ 1280x720 çš„ç›¸æœºåˆ†è¾¨ç‡
var constraints = { audio: true, video: { width: 1280, height: 720 } };

navigator.mediaDevices.getUserMedia(constraints)
.then(function(mediaStream) {
  var video = document.querySelector('video');
  video.srcObject = mediaStream;
  video.onloadedmetadata = function(e) {
    video.play();
  };
})
.catch(function(err) { console.log(err.name + ": " + err.message); }); // æ€»æ˜¯åœ¨æœ€åæ£€æŸ¥é”™è¯¯
```

### åœ¨æ—§çš„æµè§ˆå™¨ä¸­ä½¿ç”¨æ–°çš„API  

è¿™æ˜¯ä¸€ä¸ªä½¿ç”¨ navigator.mediaDevices.getUserMedia()çš„ä¾‹å­ï¼Œå¸¦ä¸€ä¸ªpolyfillä»¥é€‚åº”æ—§çš„æµè§ˆå™¨ã€‚ è¦æ³¨æ„çš„æ˜¯è¿™ä¸ªpolyfillå¹¶ä¸èƒ½ä¿®æ­£ä¸€äº›çº¦æŸè¯­æ³•ä¸Šçš„é—ç•™å·®å¼‚ï¼Œè¿™è¡¨ç¤ºçº¦æŸåœ¨æŸäº›æµè§ˆå™¨ä¸Šå¯èƒ½ä¸ä¼šå¾ˆå¥½åœ°è¿è¡Œã€‚æ¨èä½¿ç”¨å¤„ç†äº†çº¦æŸçš„ adapter.js polyfill æ¥æ›¿ä»£ã€‚  

```javascript
// è€çš„æµè§ˆå™¨å¯èƒ½æ ¹æœ¬æ²¡æœ‰å®ç° mediaDevicesï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥å…ˆè®¾ç½®ä¸€ä¸ªç©ºçš„å¯¹è±¡
if (navigator.mediaDevices === undefined) {
  navigator.mediaDevices = {};
}

// ä¸€äº›æµè§ˆå™¨éƒ¨åˆ†æ”¯æŒ mediaDevicesã€‚æˆ‘ä»¬ä¸èƒ½ç›´æ¥ç»™å¯¹è±¡è®¾ç½® getUserMedia
// å› ä¸ºè¿™æ ·å¯èƒ½ä¼šè¦†ç›–å·²æœ‰çš„å±æ€§ã€‚è¿™é‡Œæˆ‘ä»¬åªä¼šåœ¨æ²¡æœ‰getUserMediaå±æ€§çš„æ—¶å€™æ·»åŠ å®ƒã€‚
if (navigator.mediaDevices.getUserMedia === undefined) {
  navigator.mediaDevices.getUserMedia = function(constraints) {

    // é¦–å…ˆï¼Œå¦‚æœæœ‰getUserMediaçš„è¯ï¼Œå°±è·å¾—å®ƒ
    var getUserMedia = navigator.webkitGetUserMedia || navigator.mozGetUserMedia;

    // ä¸€äº›æµè§ˆå™¨æ ¹æœ¬æ²¡å®ç°å®ƒ - é‚£ä¹ˆå°±è¿”å›ä¸€ä¸ªerroråˆ°promiseçš„rejectæ¥ä¿æŒä¸€ä¸ªç»Ÿä¸€çš„æ¥å£
    if (!getUserMedia) {
      return Promise.reject(new Error('getUserMedia is not implemented in this browser'));
    }

    // å¦åˆ™ï¼Œä¸ºè€çš„navigator.getUserMediaæ–¹æ³•åŒ…è£¹ä¸€ä¸ªPromise
    return new Promise(function(resolve, reject) {
      getUserMedia.call(navigator, constraints, resolve, reject);
    });
  }
}

navigator.mediaDevices.getUserMedia({ audio: true, video: true })
.then(function(stream) {
  var video = document.querySelector('video');
  // æ—§çš„æµè§ˆå™¨å¯èƒ½æ²¡æœ‰srcObject
  if ("srcObject" in video) {
    video.srcObject = stream;
  } else {
    // é˜²æ­¢å†æ–°çš„æµè§ˆå™¨é‡Œä½¿ç”¨å®ƒï¼Œåº”ä¸ºå®ƒå·²ç»ä¸å†æ”¯æŒäº†
    video.src = window.URL.createObjectURL(stream);
  }
  video.onloadedmetadata = function(e) {
    video.play();
  };
})
.catch(function(err) {
  console.log(err.name + ": " + err.message);
});
```

### å¸§ç‡  

åœ¨æŸäº›æƒ…å†µä¸‹ï¼Œæ¯”å¦‚`WebRTC`ä¸Šä½¿ç”¨å—é™å¸¦å®½ä¼ è¾“æ—¶ï¼Œä½å¸§ç‡å¯èƒ½æ›´é€‚å®œã€‚  

```javascript
var constraints = { video: { frameRate: { ideal: 10, max: 15 } } };
```

### å‰ç½®æˆ–è€…åç½®æ‘„åƒå¤´  

åœ¨ç§»åŠ¨è®¾å¤‡ï¼ˆç”µè¯ï¼‰ä¸Š  

```javascript
var front = false;
document.getElementById('flip-button').onclick = function() { front = !front; };

var constraints = { video: { facingMode: (front? "user" : "environment") } };
```

### æƒé™  

åœ¨ä¸€ä¸ªå¯å®‰è£…çš„appï¼ˆå¦‚Firefox OS appï¼‰ä¸­ä½¿ç”¨ `getUserMedia`() ï¼Œä½ éœ€è¦åœ¨å£°æ˜æ–‡ä»¶ä¸­æŒ‡å®šä»¥ä¸‹çš„æƒé™ï¼š  

```javascript
"permissions": {
  "audio-capture": {
    "description": "Required to capture audio using getUserMedia()"
  },
  "video-capture": {
    "description": "Required to capture video using getUserMedia()"
  }
}
```

## è§†é¢‘æµçš„è·å–ä»¥åŠä¼ è¾“
```javascript
// Clientç«¯
// RTCPeerConnectionå‡è®¾å·²ç»åˆ›å»ºå¥½äº†
const pc = new RTCPeerConnection({...configs});

// è·å–è§†é¢‘æµ
navigator.mediaDevices.getUserMedia({
    audio: false,
    video: true
})
    .then(gotStream)
    .catch(function (e) {
        alert('getUserMedia() error: ' + e.name);
    });

// è·å–æœ¬åœ°è§†é¢‘æµå
function gotStream(stream) {
    localVideo.srcObject = stream;
    sendMessage('got user media'); // é€šçŸ¥å¯¹ç«¯å»ºç«‹é“¾æ¥
    // å¦‚æœæ˜¯ä¸»åŠ¨å‘èµ·é“¾æ¥çš„ç«¯
    if (isInitiator) {
        maybeStart();
    } 
}

signaling.on('message', function(message) {
    if (message === 'got user media') {
        maybeStart();
    }
})

function maybeStart() {
    // isChannelReady å¯ä»¥ç†è§£ä¸ºå½“æœ‰ä¸¤ä¸ªè®¾å¤‡åŒæ—¶åŠ å…¥ä¼šè¯æ—¶
    if (typeof localStream !== 'undefined' && isChannelReady) {
        console.log('>>>>>> creating peer connection');
        createPeerConnection();
        pc.addStream(localStream); // åŠ å…¥æœ¬åœ°çš„æµä»¥ä¼ è¾“ç»™å¯¹ç«¯
        // å¦‚æœæ˜¯ä¸»åŠ¨å‘èµ·é“¾æ¥çš„ç«¯
        if (isInitiator) {
            doCall(); // ä¸»åŠ¨å‘èµ·é€šè¯ï¼Œè¿›è¡ŒSDPäº¤æ¢
        }
    }
}

function createPeerConnection() {
    try {
        pc = new RTCPeerConnection({...configs});
        pc.onicecandidate = handleIceCandidate;
        pc.onaddstream = handleRemoteStreamAdded; // è¿™ä¸ªæ—¶å€™ä¾¿å·²ç»è·å¾—äº†å¯¹ç«¯çš„è§†é¢‘æµ
    }
}
```

# `WebRTC` æ•°æ®ä¼ è¾“
## RTCDataChannel API
https://developer.mozilla.org/zh-CN/docs/Web/API/RTCDataChannel
## ä»£ç ç¤ºä¾‹
```javascript
var pc = new RTCPeerConnection(servers,
  {optional: [{RtpDataChannels: true}]});

pc.ondatachannel = function(event) {
  receiveChannel = event.channel;
  receiveChannel.onmessage = function(event){
    document.querySelector("div#receive").innerHTML = event.data;
  };};

sendChannel = pc.createDataChannel("sendDataChannel", {reliable: false});

document.querySelector("button#send").onclick = function (){
  var data = document.querySelector("textarea#send").value;
  sendChannel.send(data);};
```
# å†™åœ¨æœ€å
## ä¿ºçš„å°Demo
æ‰“ä¸ªç”µè¯8: https://neotape.live
## Debug `WebRTC` In Chrome
chrome://webrtc-internals/
## Video Chat for the Web Android and iOSï¼šå®‰å“iOSä¹Ÿå¯ä½¿ç”¨`WebRTC`
https://docs.google.com/presentation/d/1CjuTaY2J9P5xrFDtRCh6VmS7Iw2UBbm-JEwzCHQCYkE/edit#slide=id.g521d01055_1_141
## `WebRTC` & RTMP æ¯”è¾ƒï¼šRTMPæ˜¯ç›´æ’­ä½¿ç”¨æ¯”è¾ƒå¤šçš„åœºæ™¯
https://segmentfault.com/a/1190000018134618
## `WebRTC` Samplesï¼šä¸€äº›ç¤ºä¾‹
https://webrtc.github.io/samples/
## `WebRTC` in the real worldï¼šä¸é”™çš„æ–‡ç« 
https://www.html5rocks.com/en/tutorials/webrtc/infrastructure/
## `WebRTC` Experimentsï¼šä¸€äº›`WebRTC`å®éªŒ
https://github.com/muaz-khan/WebRTC-Experiment
## `WebRTC`çš„å‰ä¸–ä»Šç”Ÿï¼šä¸€ç¯‡å¾ˆå¥½çš„ç¿»è¯‘
https://blog.coding.net/blog/getting-started-with-webrtc
## `WebRTC` 1.0: Real-time Communication Between Browsersï¼š`WebRTC` APIæ–‡æ¡£
https://www.w3.org/TR/webrtc/
## RTCMultiConnection.jsï¼šå¼€æºçš„`WebRTC`åº“
https://www.rtcmulticonnection.org/
## Pure Go implementation of the `WebRTC` API
https://github.com/pion/webrtc
